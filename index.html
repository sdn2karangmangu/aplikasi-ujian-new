<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PGK Ujian Online â€” SDN 2 Karangmangu</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN SYSTEM â€” Deep Navy + Amber Gold
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:       #0d1b2a;
  --navy-2:     #1b2d42;
  --navy-3:     #243447;
  --navy-4:     #2f4460;
  --gold:       #f5a623;
  --gold-dk:    #d4891a;
  --gold-lt:    #fff8ec;
  --gold-bd:    #fde8b0;
  --teal:       #00c9a7;
  --teal-lt:    #e6faf6;
  --teal-bd:    #99e8d8;
  --red:        #ff4d6d;
  --red-lt:     #fff0f3;
  --red-bd:     #ffb3c1;
  --green:      #06d6a0;
  --green-lt:   #e8faf5;
  --green-bd:   #9ae8d1;
  --purple:     #7c3aed;
  --purple-lt:  #f5f0ff;
  --purple-bd:  #c4b5fd;
  --blue:       #3b82f6;
  --blue-lt:    #eff6ff;
  --blue-bd:    #bfdbfe;
  --white:      #ffffff;
  --off-white:  #f8f9fc;
  --surface:    #f2f4f8;
  --border:     #e4e8f0;
  --border2:    #c8d0e0;
  --text:       #0d1b2a;
  --sub:        #4a5568;
  --muted:      #8898a9;
  --shadow-sm:  0 1px 4px rgba(13,27,42,.08);
  --shadow:     0 4px 20px rgba(13,27,42,.12);
  --shadow-lg:  0 12px 48px rgba(13,27,42,.18);
  --radius:     14px;
  --radius-sm:  9px;
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { scroll-behavior:smooth; }
body {
  font-family: 'Sora', sans-serif;
  background: var(--off-white);
  min-height: 100vh;
  color: var(--text);
  line-height: 1.6;
}

/* â•â• TOPBAR â•â• */
.topbar {
  background: var(--navy);
  padding: 0 32px;
  position: sticky; top:0; z-index:300;
  box-shadow: 0 2px 20px rgba(0,0,0,.3);
}
.topbar-inner {
  max-width: 1100px; margin: 0 auto;
  height: 62px; display:flex; align-items:center; justify-content:space-between; gap:16px;
}
.brand { display:flex; align-items:center; gap:12px; }
.brand-mark {
  width:38px; height:38px;
  background: linear-gradient(135deg, var(--gold), var(--gold-dk));
  border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  font-size:18px;
  box-shadow: 0 2px 12px rgba(245,166,35,.4);
}
.brand-text { color:white; font-size:15px; font-weight:700; letter-spacing:-0.02em; }
.brand-text span { color:var(--gold); }
.brand-sub { color: rgba(255,255,255,.45); font-size:11px; font-weight:400; }

.nav-pill {
  display: flex; gap:4px;
  background: rgba(255,255,255,.08);
  border-radius: 30px;
  padding: 4px;
}
.nav-pill-btn {
  background:none; border:none; color:rgba(255,255,255,.5);
  font-family:'Sora',sans-serif; font-size:12px; font-weight:600;
  padding: 7px 16px; border-radius:26px; cursor:pointer;
  transition: all .2s; display:flex; align-items:center; gap:6px; white-space:nowrap;
}
.nav-pill-btn:hover { color:white; }
.nav-pill-btn.active { background: var(--gold); color: var(--navy); }

.topbar-badge {
  background: rgba(245,166,35,.15); border:1px solid rgba(245,166,35,.3);
  color:var(--gold); font-size:11px; font-weight:700;
  padding:5px 12px; border-radius:20px; letter-spacing:0.05em;
}

/* â•â• LAYOUT â•â• */
.shell { max-width:1100px; margin:0 auto; padding:28px 20px 64px; }

/* â•â• CARDS â•â• */
.card {
  background: var(--white);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
}
.card-header {
  padding:20px 28px;
  border-bottom:1px solid var(--border);
  display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
  background: var(--surface);
}
.card-title { font-size:16px; font-weight:700; display:flex; align-items:center; gap:8px; }
.card-body { padding:28px; }

/* â•â• SECTION HEADER â•â• */
.section-hero {
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-2) 100%);
  border-radius: var(--radius) var(--radius) 0 0;
  padding: 32px 36px;
  color: white;
  position: relative; overflow:hidden;
}
.section-hero::before {
  content:'';
  position:absolute; top:-40px; right:-40px;
  width:200px; height:200px;
  background: radial-gradient(circle, rgba(245,166,35,.15) 0%, transparent 70%);
  border-radius:50%;
}
.section-hero h1 { font-size:26px; font-weight:800; letter-spacing:-0.03em; margin-bottom:4px; }
.section-hero h1 em { color:var(--gold); font-style:normal; }
.section-hero p { font-size:13.5px; color:rgba(255,255,255,.6); }
.hero-chips { display:flex; gap:10px; margin-top:16px; flex-wrap:wrap; }
.hero-chip {
  background: rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.15);
  color:white; font-size:12px; font-weight:600;
  padding:6px 14px; border-radius:20px; display:flex; align-items:center; gap:6px;
}
.hero-chip .dot { width:7px; height:7px; border-radius:50%; background:var(--gold); }

/* â•â• GRID â•â• */
.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
.grid-3 { display:grid; grid-template-columns:repeat(3,1fr); gap:14px; }
.grid-4 { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }

/* â•â• STAT CARDS â•â• */
.stat-card {
  background:var(--white); border:1px solid var(--border);
  border-radius: var(--radius-sm); padding:18px 20px;
  position:relative; overflow:hidden; transition:transform .15s, box-shadow .15s;
}
.stat-card:hover { transform:translateY(-2px); box-shadow:var(--shadow); }
.stat-card-stripe { position:absolute; top:0; left:0; bottom:0; width:4px; border-radius:4px 0 0 4px; }
.stat-val { font-size:34px; font-weight:800; letter-spacing:-0.04em; line-height:1; }
.stat-lbl { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); margin-top:6px; }
.stat-icon { font-size:20px; margin-bottom:10px; }

/* â•â• BUTTONS â•â• */
.btn {
  display:inline-flex; align-items:center; gap:8px;
  font-family:'Sora',sans-serif; font-size:13.5px; font-weight:600;
  padding:11px 22px; border-radius:var(--radius-sm);
  cursor:pointer; border:none; transition:all .18s;
  white-space:nowrap; letter-spacing:0.01em;
}
.btn-block { width:100%; justify-content:center; }
.btn-lg { padding:14px 28px; font-size:15px; border-radius:var(--radius); }
.btn-sm { padding:7px 14px; font-size:12px; border-radius:7px; }
.btn-primary {
  background: var(--navy); color:white;
  box-shadow: 0 2px 10px rgba(13,27,42,.25);
}
.btn-primary:hover { background:var(--navy-2); transform:translateY(-1px); box-shadow:0 4px 18px rgba(13,27,42,.35); }
.btn-primary:disabled { opacity:.5; cursor:not-allowed; transform:none; }
.btn-gold {
  background: linear-gradient(135deg, var(--gold), var(--gold-dk)); color:var(--navy);
  box-shadow: 0 2px 12px rgba(245,166,35,.3);
}
.btn-gold:hover { transform:translateY(-1px); box-shadow:0 4px 20px rgba(245,166,35,.45); }
.btn-teal { background:var(--teal); color:white; box-shadow:0 2px 10px rgba(0,201,167,.25); }
.btn-teal:hover { background:#00b090; transform:translateY(-1px); }
.btn-red { background:var(--red); color:white; box-shadow:0 2px 10px rgba(255,77,109,.25); }
.btn-red:hover { filter:brightness(1.1); transform:translateY(-1px); }
.btn-ghost { background:transparent; color:var(--sub); border:1.5px solid var(--border); }
.btn-ghost:hover { border-color:var(--border2); background:var(--surface); color:var(--text); }
.btn-ghost:disabled { opacity:.5; cursor:not-allowed; }

/* â•â• FORMS â•â• */
.form-group { margin-bottom:18px; }
.form-label {
  display:block; font-size:11px; font-weight:700;
  text-transform:uppercase; letter-spacing:0.08em; color:var(--sub); margin-bottom:7px;
}
.form-control {
  width:100%; padding:11px 14px;
  background:var(--surface); border:1.5px solid var(--border);
  border-radius:var(--radius-sm);
  font-family:'Sora',sans-serif; font-size:13.5px; color:var(--text);
  outline:none; transition:border-color .18s, box-shadow .18s;
}
.form-control:focus { border-color:var(--gold); box-shadow:0 0 0 3px rgba(245,166,35,.12); background:white; }
.form-control::placeholder { color:var(--muted); }
.form-control.mono { font-family:'JetBrains Mono',monospace; font-size:12.5px; }
textarea.form-control { min-height:140px; resize:vertical; line-height:1.7; }
select.form-control { cursor:pointer; }

/* â•â• ALERTS â•â• */
.alert {
  padding:13px 16px; border-radius:10px; font-size:13px; font-weight:500;
  display:flex; gap:10px; align-items:flex-start; margin-bottom:14px; border:1.5px solid;
  line-height:1.6;
}
.alert-icon { font-size:15px; flex-shrink:0; margin-top:1px; }
.alert-info    { background:var(--blue-lt);   color:#1e3a5f; border-color:var(--blue-bd); }
.alert-success { background:var(--green-lt);  color:#065f46; border-color:var(--green-bd); }
.alert-warning { background:var(--gold-lt);   color:#78350f; border-color:var(--gold-bd); }
.alert-danger  { background:var(--red-lt);    color:#9b1c31; border-color:var(--red-bd); }

/* â•â• BADGE â•â• */
.badge {
  display:inline-flex; align-items:center; gap:4px;
  font-size:10.5px; font-weight:700; letter-spacing:0.06em;
  padding:4px 10px; border-radius:20px; text-transform:uppercase;
}
.badge-gold    { background:var(--gold-lt);   color:var(--gold-dk); border:1px solid var(--gold-bd); }
.badge-teal    { background:var(--teal-lt);   color:#007a65; border:1px solid var(--teal-bd); }
.badge-red     { background:var(--red-lt);    color:var(--red);     border:1px solid var(--red-bd); }
.badge-green   { background:var(--green-lt);  color:#047857;        border:1px solid var(--green-bd); }
.badge-purple  { background:var(--purple-lt); color:var(--purple);  border:1px solid var(--purple-bd); }
.badge-navy    { background:rgba(13,27,42,.07); color:var(--navy);  border:1px solid rgba(13,27,42,.15); }

/* â•â• HIDDEN â•â• */
.hidden { display:none !important; }

/* â•â• SEPARATOR â•â• */
.sep { height:1px; background:var(--border); margin:20px 0; }
.divider { display:flex; align-items:center; gap:12px; margin:20px 0; color:var(--muted); font-size:12px; font-weight:600; letter-spacing:0.07em; text-transform:uppercase; }
.divider::before, .divider::after { content:''; flex:1; height:1px; background:var(--border); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.admin-grid { display:grid; grid-template-columns:220px 1fr; gap:0; min-height:calc(100vh - 90px); }
.admin-sidebar {
  background: var(--navy);
  padding: 24px 16px;
  display:flex; flex-direction:column; gap:4px;
}
.sidebar-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.1em; color:rgba(255,255,255,.3); padding:6px 12px; margin-top:8px; }
.sidebar-btn {
  display:flex; align-items:center; gap:10px;
  padding:11px 14px; border-radius:9px;
  background:none; border:none; cursor:pointer;
  font-family:'Sora',sans-serif; font-size:13px; font-weight:500;
  color:rgba(255,255,255,.55); text-align:left;
  transition:all .18s; width:100%;
}
.sidebar-btn:hover { background:rgba(255,255,255,.08); color:white; }
.sidebar-btn.active { background:rgba(245,166,35,.18); color:var(--gold); }
.sidebar-btn .s-icon { font-size:16px; width:20px; text-align:center; }
.sidebar-btn .s-count {
  margin-left:auto; background:rgba(245,166,35,.2); color:var(--gold);
  font-size:10px; font-weight:700; padding:2px 7px; border-radius:10px;
}
.admin-content { background:var(--off-white); overflow-y:auto; }
.admin-content-inner { padding:28px; max-width:900px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPREADSHEET DB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sheet-toolbar {
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  padding:14px 18px; background:var(--surface);
  border:1px solid var(--border); border-radius:var(--radius-sm);
  margin-bottom:14px;
}
.sheet-search { flex:1; min-width:160px; position:relative; }
.sheet-search-icon { position:absolute; left:10px; top:50%; transform:translateY(-50%); color:var(--muted); font-size:14px; pointer-events:none; }
.sheet-search .form-control { padding-left:30px; }
.sheet-wrap { overflow:auto; border:1px solid var(--border); border-radius:var(--radius-sm); background:white; max-height:520px; }
.sheet-table { width:100%; border-collapse:collapse; font-size:12.5px; min-width:900px; }
.sheet-table thead tr { background:var(--navy); position:sticky; top:0; z-index:10; }
.sheet-table th {
  padding:11px 14px; text-align:left;
  font-size:10.5px; font-weight:600; text-transform:uppercase;
  letter-spacing:0.08em; color:rgba(255,255,255,.7); white-space:nowrap;
  border-right:1px solid rgba(255,255,255,.08);
}
.sheet-table th:first-child { color:rgba(255,255,255,.35); font-size:9px; }
.sheet-table td {
  padding:10px 14px; border-bottom:1px solid var(--border);
  border-right:1px solid rgba(0,0,0,.04); vertical-align:top;
  transition:background .1s;
}
.sheet-table tbody tr:hover td { background:rgba(245,166,35,.04); }
.sheet-table tbody tr:last-child td { border-bottom:none; }
.cell-id { font-family:'JetBrains Mono',monospace; font-size:10px; color:var(--muted); }
.cell-score { font-size:16px; font-weight:800; }
.cell-name { font-weight:600; color:var(--text); }
.cell-nim { font-family:'JetBrains Mono',monospace; font-size:11px; background:rgba(245,166,35,.1); color:var(--gold-dk); padding:2px 7px; border-radius:5px; display:inline-block; }
.cell-time { font-size:11px; color:var(--muted); }
.cell-answers { font-size:11px; color:var(--sub); }
.sheet-empty { text-align:center; padding:60px 20px; color:var(--muted); }
.sheet-empty-icon { font-size:40px; margin-bottom:12px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PGK SOAL EDITOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pgk-editor { background:var(--surface); border:1.5px solid var(--border); border-radius:var(--radius); overflow:hidden; margin-bottom:16px; transition: box-shadow .2s; }
.pgk-editor:hover { box-shadow: var(--shadow-sm); }
.pgk-editor-head {
  display:flex; align-items:center; gap:12px; padding:14px 18px;
  background:white; border-bottom:1px solid var(--border);
}
.pgk-q-num {
  width:32px; height:32px; border-radius:8px;
  background:var(--navy); color:var(--gold);
  display:flex; align-items:center; justify-content:center;
  font-size:12px; font-weight:800; flex-shrink:0;
}
.pgk-editor-body { padding:18px; }
.pgk-option-row {
  display:flex; align-items:center; gap:10px; margin-bottom:10px;
}
.pgk-option-letter {
  width:32px; height:32px; border-radius:7px; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-size:12px; font-weight:800; border:1.5px solid var(--border);
  background:var(--surface); color:var(--muted);
}
.pgk-check {
  width:20px; height:20px; border-radius:5px; flex-shrink:0;
  border:2px solid var(--border); background:white; cursor:pointer;
  appearance:none; -webkit-appearance:none;
  display:flex; align-items:center; justify-content:center;
  position:relative; transition:all .15s;
}
.pgk-check:checked { background:var(--teal); border-color:var(--teal); }
.pgk-check:checked::after { content:'âœ“'; color:white; font-size:11px; font-weight:800; position:absolute; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STUDENT EXAM UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.exam-shell { max-width: 720px; margin:0 auto; padding:24px 16px 60px; }

/* LOGIN */
.login-card {
  background:white; border-radius:var(--radius);
  box-shadow:var(--shadow); overflow:hidden;
  border:1px solid var(--border);
}
.login-hero {
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy-4) 100%);
  padding:40px 36px 32px; text-align:center; position:relative; overflow:hidden;
}
.login-hero::after {
  content:'';
  position:absolute; bottom:-30px; left:50%; transform:translateX(-50%);
  width:120px; height:60px;
  background: radial-gradient(ellipse, rgba(245,166,35,.2) 0%, transparent 70%);
}
.login-icon {
  width:72px; height:72px; margin:0 auto 18px;
  background: linear-gradient(135deg, var(--gold), var(--gold-dk));
  border-radius:20px; display:flex; align-items:center; justify-content:center;
  font-size:32px; box-shadow:0 6px 24px rgba(245,166,35,.35);
}
.login-hero h1 { font-size:26px; font-weight:800; color:white; letter-spacing:-0.03em; margin-bottom:6px; }
.login-hero p { font-size:13.5px; color:rgba(255,255,255,.55); }
.login-info-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:0; border-bottom:1px solid var(--border); }
.login-info-item {
  padding:16px 20px; text-align:center; border-right:1px solid var(--border);
}
.login-info-item:last-child { border-right:none; }
.login-info-val { font-size:24px; font-weight:800; color:var(--navy); line-height:1; }
.login-info-lbl { font-size:10px; text-transform:uppercase; letter-spacing:0.08em; color:var(--muted); font-weight:600; margin-top:4px; }
.login-body { padding:28px; }

/* TIMER */
.timer-bar {
  background: linear-gradient(135deg, var(--navy), var(--navy-2));
  border-radius:12px; padding:14px 22px;
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:18px; box-shadow:0 4px 16px rgba(13,27,42,.25);
  border:1px solid rgba(255,255,255,.08);
}
.timer-bar.warn { background: linear-gradient(135deg,#c53030,#e53e3e); }
.timer-label { font-size:10.5px; font-weight:700; text-transform:uppercase; letter-spacing:0.1em; color:rgba(255,255,255,.55); margin-bottom:2px; }
.timer-val { font-size:34px; font-weight:800; color:white; letter-spacing:0.05em; font-variant-numeric:tabular-nums; font-family:'JetBrains Mono',monospace; }
.timer-icon { font-size:26px; animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

/* PROGRESS */
.prog-meta { display:flex; justify-content:space-between; margin-bottom:6px; }
.prog-meta span { font-size:12px; font-weight:600; color:var(--muted); }
.prog-meta strong { color:var(--gold-dk); }
.prog-track { height:6px; background:var(--border); border-radius:3px; margin-bottom:20px; overflow:hidden; }
.prog-fill { height:100%; background:linear-gradient(90deg, var(--gold), var(--teal)); border-radius:3px; transition:width .5s cubic-bezier(.23,1,.32,1); }

/* QUESTION CARD */
.q-wrap { background:white; border:1.5px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow-sm); }
.q-head { padding:18px 24px; border-bottom:1px solid var(--border); background:var(--surface); display:flex; align-items:center; gap:12px; }
.q-num-badge {
  background:var(--navy); color:var(--gold);
  font-size:11px; font-weight:800; padding:5px 13px;
  border-radius:20px; white-space:nowrap;
}
.q-type-tag { }
.q-body { padding:24px; }
.q-instruction {
  background: linear-gradient(135deg, rgba(0,201,167,.08), rgba(0,201,167,.04));
  border:1px solid var(--teal-bd); border-radius:9px;
  padding:11px 15px; margin-bottom:18px;
  font-size:12.5px; font-weight:600; color:#007a65;
  display:flex; align-items:center; gap:8px;
}
.q-text { font-size:16px; font-weight:600; color:var(--text); line-height:1.7; margin-bottom:20px; }

/* PGK OPTIONS */
.pgk-options { display:flex; flex-direction:column; gap:10px; }
.pgk-opt {
  display:flex; align-items:flex-start; gap:14px;
  padding:14px 18px; border:2px solid var(--border);
  border-radius:10px; cursor:pointer; transition:all .18s;
  background:white; text-align:left; width:100%; font-family:'Sora',sans-serif;
}
.pgk-opt:hover { border-color:var(--gold-bd); background:var(--gold-lt); }
.pgk-opt.checked { border-color:var(--teal); background:var(--teal-lt); }
.pgk-opt.result-correct { border-color:var(--green); background:var(--green-lt); }
.pgk-opt.result-wrong   { border-color:var(--red); background:var(--red-lt); }
.pgk-opt.result-missed  { border-color:var(--gold); background:var(--gold-lt); }
.pgk-opt-checkbox {
  width:22px; height:22px; border-radius:6px; flex-shrink:0;
  border:2px solid var(--border2); background:white;
  display:flex; align-items:center; justify-content:center;
  font-size:13px; font-weight:800; transition:all .15s; margin-top:1px;
}
.pgk-opt.checked .pgk-opt-checkbox { background:var(--teal); border-color:var(--teal); color:white; }
.pgk-opt.result-correct .pgk-opt-checkbox { background:var(--green); border-color:var(--green); color:white; }
.pgk-opt.result-wrong   .pgk-opt-checkbox { background:var(--red); border-color:var(--red); color:white; }
.pgk-opt.result-missed  .pgk-opt-checkbox { background:var(--gold); border-color:var(--gold-dk); color:var(--navy); }
.pgk-opt-letter {
  width:28px; height:28px; flex-shrink:0; border-radius:7px;
  background:var(--surface); border:1px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  font-size:11.5px; font-weight:800; color:var(--muted); transition:all .15s;
}
.pgk-opt.checked .pgk-opt-letter { background:rgba(0,201,167,.15); border-color:var(--teal-bd); color:#007a65; }
.pgk-opt-text { font-size:14px; font-weight:500; color:var(--text); line-height:1.55; flex:1; }

/* ANSWER KEY */
.answer-key-note {
  margin-top:12px; padding:12px 14px;
  background:var(--navy); border-radius:9px;
  font-size:12px; color:rgba(255,255,255,.7); line-height:1.6;
}
.answer-key-note strong { color:var(--gold); }

/* NAV BTNS */
.nav-row { display:flex; gap:10px; padding:20px 24px 24px; }
.nav-row .btn { flex:1; justify-content:center; }

/* RESULT */
.result-hero {
  background: linear-gradient(135deg, var(--navy), var(--navy-4));
  padding:36px; text-align:center; color:white; position:relative; overflow:hidden;
}
.result-hero::before {
  content:''; position:absolute; inset:0;
  background: radial-gradient(ellipse at 50% 0%, rgba(245,166,35,.15) 0%, transparent 70%);
}
.score-ring-wrap { position:relative; display:inline-block; margin-bottom:20px; }
.score-ring-wrap svg { width:150px; height:150px; transform:rotate(-90deg); }
.score-ring-wrap circle { fill:none; stroke-width:10; }
.ring-bg   { stroke:rgba(255,255,255,.1); }
.ring-fill { stroke-linecap:round; stroke-dasharray:345; stroke-dashoffset:345; transition:stroke-dashoffset 1.8s cubic-bezier(.23,1,.32,1); }
.ring-fill.clr-gold  { stroke:var(--gold); }
.ring-fill.clr-teal  { stroke:var(--teal); }
.ring-fill.clr-red   { stroke:var(--red); }
.score-center { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; }
.score-big { font-size:42px; font-weight:800; letter-spacing:-0.04em; color:white; line-height:1; }
.score-of  { font-size:11px; color:rgba(255,255,255,.4); font-weight:600; text-transform:uppercase; letter-spacing:0.08em; }
.result-status { font-size:22px; font-weight:800; margin-bottom:6px; }
.result-sub { font-size:13.5px; color:rgba(255,255,255,.55); }

.result-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; padding:24px; }
.result-chip { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:14px 16px; }
.result-chip-lbl { font-size:10.5px; color:var(--muted); font-weight:600; text-transform:uppercase; letter-spacing:0.07em; margin-bottom:5px; }
.result-chip-val { font-size:16px; font-weight:700; color:var(--text); }

/* DETAIL TABLE */
.detail-head { padding:16px 24px 10px; border-top:1px solid var(--border); font-size:14px; font-weight:700; display:flex; align-items:center; gap:8px; }
.detail-table-wrap { overflow:auto; }
.detail-table { width:100%; border-collapse:collapse; font-size:12.5px; }
.detail-table th { padding:10px 14px; background:var(--surface); border-bottom:2px solid var(--border); font-size:10.5px; font-weight:700; text-transform:uppercase; letter-spacing:0.07em; color:var(--muted); text-align:left; }
.detail-table td { padding:11px 14px; border-bottom:1px solid var(--border); vertical-align:top; }
.detail-table tbody tr:last-child td { border-bottom:none; }

/* SPINNER */
.spinner { display:inline-block; width:14px; height:14px; border:2px solid rgba(0,0,0,.1); border-top-color:currentColor; border-radius:50%; animation:spin .65s linear infinite; vertical-align:middle; margin-right:5px; }
@keyframes spin { to{transform:rotate(360deg)} }

/* ANIMATION */
@keyframes fadeUp { from{opacity:0;transform:translateY(18px)} to{opacity:1;transform:translateY(0)} }
.animate-in { animation:fadeUp .4s ease both; }

/* SCROLL */
::-webkit-scrollbar { width:5px; height:5px; }
::-webkit-scrollbar-track { background:var(--surface); }
::-webkit-scrollbar-thumb { background:var(--border2); border-radius:3px; }

/* RESPONSIVE */
@media(max-width:768px){
  .admin-grid { grid-template-columns:1fr; }
  .admin-sidebar { flex-direction:row; overflow-x:auto; padding:12px; gap:4px; }
  .sidebar-label { display:none; }
  .sidebar-btn { padding:10px 14px; min-width:max-content; }
  .grid-2, .grid-3, .grid-4 { grid-template-columns:1fr; }
  .result-grid { grid-template-columns:1fr; }
  .login-info-grid { grid-template-columns:1fr; }
  .nav-row { flex-wrap:wrap; }
  .topbar-inner { height:54px; }
  .nav-pill { display:none; }
  .admin-content-inner { padding:16px; }
  .shell { padding:16px 12px 40px; }
}
</style>
</head>
<body>

<!-- â•â• TOPBAR â•â• -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="brand-mark">ğŸ“</div>
      <div>
        <div class="brand-text">PGK<span>Online</span></div>
        <div class="brand-sub">SDN 2 Karangmangu</div>
      </div>
    </div>
    <div class="nav-pill" id="mainNav">
      <button class="nav-pill-btn active" onclick="switchMode('admin',this)">âš™ï¸ Admin</button>
      <button class="nav-pill-btn" onclick="switchMode('student',this)">ğŸ“ Ujian Siswa</button>
    </div>
    <div id="topbarRight"><span class="topbar-badge">ğŸ‘¤ Admin Mode</span></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ADMIN MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="adminMode">
  <div class="admin-grid">
    <!-- SIDEBAR -->
    <div class="admin-sidebar">
      <div class="sidebar-label">SOAL</div>
      <button class="sidebar-btn active" onclick="showAdminSection('soal',this)">
        <span class="s-icon">ğŸ“</span> Buat Soal PGK
        <span class="s-count" id="soalCount">0</span>
      </button>
      <button class="sidebar-btn" onclick="showAdminSection('import',this)">
        <span class="s-icon">ğŸ“„</span> Import CSV
      </button>
      <div class="sidebar-label">PENGATURAN</div>
      <button class="sidebar-btn" onclick="showAdminSection('settings',this)">
        <span class="s-icon">âš™ï¸</span> Pengaturan Ujian
      </button>
      <div class="sidebar-label">DATA</div>
      <button class="sidebar-btn" onclick="showAdminSection('database',this)">
        <span class="s-icon">ğŸ—„ï¸</span> Database Hasil
        <span class="s-count" id="dbCount">0</span>
      </button>
      <button class="sidebar-btn" onclick="showAdminSection('analytics',this)">
        <span class="s-icon">ğŸ“Š</span> Analitik
      </button>
    </div>

    <!-- CONTENT -->
    <div class="admin-content">
      <div class="admin-content-inner">

        <!-- â•â• SOAL EDITOR â•â• -->
        <div id="soalSection">
          <div class="section-hero animate-in" style="border-radius:var(--radius) var(--radius) 0 0; margin-bottom:0">
            <h1>ğŸ“ Editor Soal <em>PGK</em></h1>
            <p>Pilihan Ganda Kompleks â€” satu soal dapat memiliki beberapa jawaban benar</p>
            <div class="hero-chips">
              <div class="hero-chip"><div class="dot"></div> Minimal 1 jawaban benar</div>
              <div class="hero-chip"><div class="dot"></div> Maks. 4 opsi per soal</div>
              <div class="hero-chip"><div class="dot"></div> Penilaian parsial otomatis</div>
            </div>
          </div>
          <div style="background:white; border:1px solid var(--border); border-top:none; border-radius:0 0 var(--radius) var(--radius); padding:22px; margin-bottom:20px;">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn btn-gold" onclick="addQuestion()">ï¼‹ Tambah Soal</button>
              <button class="btn btn-ghost btn-sm" onclick="clearAllQuestions()">ğŸ—‘ Hapus Semua</button>
              <button class="btn btn-teal btn-sm" onclick="saveQuestionsToLS()">ğŸ’¾ Simpan Soal</button>
              <button class="btn btn-ghost btn-sm" onclick="loadSampleQuestions()">âœ¨ Muat Contoh</button>
            </div>
          </div>
          <div id="questionsEditorContainer"></div>
          <button class="btn btn-gold btn-block" style="margin-top:8px" onclick="addQuestion()">ï¼‹ Tambah Soal Baru</button>
        </div>

        <!-- â•â• IMPORT CSV â•â• -->
        <div id="importSection" class="hidden">
          <div class="section-hero animate-in">
            <h1>ğŸ“„ Import Soal <em>CSV</em></h1>
            <p>Upload file CSV dengan format PGK â€” multiple jawaban benar dipisah tanda <code style="background:rgba(255,255,255,.15);padding:1px 6px;border-radius:4px">|</code></p>
          </div>
          <div class="card" style="margin-top:16px;">
            <div class="card-body">
              <div class="alert alert-info">
                <span class="alert-icon">â„¹ï¸</span>
                <div>
                  <strong>Format CSV (pemisah titik koma):</strong><br>
                  <code style="font-family:'JetBrains Mono',monospace;font-size:12px;display:block;margin-top:6px;background:rgba(59,130,246,.08);padding:10px 12px;border-radius:6px;line-height:1.8">
                    soal;opsi_a;opsi_b;opsi_c;opsi_d;jawaban_benar;penjelasan<br>
                    Manakah yang benar?;Pernyataan A;Pernyataan B;Pernyataan C;Pernyataan D;0|2;A dan C benar karena...
                  </code>
                  <span style="font-size:12px;color:var(--sub);display:block;margin-top:8px">* <strong>jawaban_benar</strong>: indeks 0=A, 1=B, 2=C, 3=D, pisah dengan <strong>|</strong> untuk multiple (misal: <code>0|2</code> = A dan C benar)</span>
                  <span style="font-size:12px;color:var(--sub)">* <strong>penjelasan</strong>: opsional, ditampilkan di pembahasan</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Upload File CSV</label>
                <input type="file" id="csvFileInput" accept=".csv" class="form-control">
              </div>
              <div class="form-group">
                <label class="form-label">Atau Paste CSV Langsung</label>
                <textarea id="csvTextInput" class="form-control mono" placeholder="soal;opsi_a;opsi_b;opsi_c;opsi_d;jawaban_benar;penjelasan&#10;Manakah yang benar?;A saja;B saja;A dan B;D saja;0|2;..."></textarea>
              </div>
              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <button class="btn btn-gold" style="flex:2;justify-content:center" onclick="importCSV()">ğŸ“¥ Import Soal</button>
                <button class="btn btn-ghost" style="flex:1;justify-content:center" onclick="exportQuestionsCSV()">â¬† Export CSV</button>
              </div>
              <div id="importStatus" style="margin-top:12px"></div>
            </div>
          </div>
        </div>

        <!-- â•â• SETTINGS â•â• -->
        <div id="settingsSection" class="hidden">
          <div class="section-hero animate-in">
            <h1>âš™ï¸ <em>Pengaturan</em> Ujian</h1>
            <p>Konfigurasi durasi, nama ujian, dan sistem penilaian</p>
          </div>
          <div class="card" style="margin-top:16px;">
            <div class="card-body">
              <div class="grid-2">
                <div class="form-group">
                  <label class="form-label">Nama Ujian / Mata Pelajaran</label>
                  <input type="text" id="examName" class="form-control" value="Ujian PGK Semester 1" placeholder="Nama ujian...">
                </div>
                <div class="form-group">
                  <label class="form-label">Nama Sekolah / Kelas</label>
                  <input type="text" id="examSchool" class="form-control" value="SDN 2 Karangmangu" placeholder="Nama sekolah...">
                </div>
                <div class="form-group">
                  <label class="form-label">Durasi (menit)</label>
                  <input type="number" id="examDuration" class="form-control" value="60" min="5" max="300">
                </div>
                <div class="form-group">
                  <label class="form-label">KKM (Nilai Minimum Lulus)</label>
                  <input type="number" id="examKKM" class="form-control" value="60" min="0" max="100">
                </div>
              </div>
              <div class="sep"></div>
              <div class="card-title" style="font-size:14px;margin-bottom:14px;">ğŸ¯ Sistem Penilaian PGK</div>
              <div class="alert alert-info">
                <span class="alert-icon">ğŸ“</span>
                <div style="font-size:13px;line-height:1.7">
                  <strong>Penilaian Parsial:</strong> Nilai per soal dihitung berdasarkan ketepatan memilih semua opsi yang benar.<br>
                  Rumus: <code style="background:rgba(59,130,246,.1);padding:2px 6px;border-radius:4px">(Benar dipilih Ã· Total jawaban benar) Ã— (1 - Salah dipilih Ã· Total opsi) Ã— 100</code>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Mode Penilaian</label>
                <select id="scoringMode" class="form-control">
                  <option value="partial">Parsial â€” poin proporsional per soal</option>
                  <option value="strict">Ketat â€” harus semua benar untuk dapat poin</option>
                </select>
              </div>
              <button class="btn btn-gold btn-block btn-lg" onclick="saveSettings()">ğŸ’¾ Simpan Pengaturan</button>
              <div id="settingsStatus" style="margin-top:10px"></div>
            </div>
          </div>
        </div>

        <!-- â•â• DATABASE â•â• -->
        <div id="databaseSection" class="hidden">
          <div class="section-hero animate-in">
            <h1>ğŸ—„ï¸ <em>Database</em> Hasil Ujian</h1>
            <p>Spreadsheet interaktif â€” filter, sort, export hasil ujian siswa</p>
          </div>

          <!-- SUMMARY STATS -->
          <div id="dbStats" style="margin-top:16px;margin-bottom:16px;"></div>

          <!-- SPREADSHEET -->
          <div class="sheet-toolbar">
            <div class="sheet-search">
              <span class="sheet-search-icon">ğŸ”</span>
              <input type="text" id="sheetSearch" class="form-control" placeholder="Cari nama, NIS..." oninput="filterSheet()">
            </div>
            <select class="form-control" id="sheetFilterStatus" onchange="filterSheet()" style="width:auto;min-width:130px">
              <option value="">Semua Status</option>
              <option value="LULUS">âœ… Lulus</option>
              <option value="TIDAK LULUS">âŒ Tidak Lulus</option>
            </select>
            <select class="form-control" id="sheetSort" onchange="renderSheet()" style="width:auto;min-width:130px">
              <option value="newest">Terbaru Dulu</option>
              <option value="score_desc">Nilai Tertinggi</option>
              <option value="score_asc">Nilai Terendah</option>
              <option value="name">Nama A-Z</option>
            </select>
            <button class="btn btn-teal btn-sm" onclick="exportResultsCSV()">ğŸ“¥ Export CSV</button>
            <button class="btn btn-ghost btn-sm" onclick="clearDatabase()">ğŸ—‘ Hapus Data</button>
          </div>
          <div class="sheet-wrap">
            <table class="sheet-table">
              <thead>
                <tr>
                  <th style="width:36px">#</th>
                  <th>ğŸ• Waktu</th>
                  <th>ğŸ†” NIS</th>
                  <th>ğŸ‘¤ Nama Siswa</th>
                  <th>ğŸ“Š Nilai</th>
                  <th>âœ… Benar</th>
                  <th>ğŸ“‹ Total</th>
                  <th>â± Durasi</th>
                  <th>ğŸ† Status</th>
                </tr>
              </thead>
              <tbody id="sheetBody">
                <tr><td colspan="9"><div class="sheet-empty"><div class="sheet-empty-icon">ğŸ“­</div><div>Belum ada data ujian</div></div></td></tr>
              </tbody>
            </table>
          </div>
          <div style="margin-top:10px;font-size:11.5px;color:var(--muted);display:flex;justify-content:space-between">
            <span id="sheetCount">0 baris</span>
            <span>Data tersimpan di browser (localStorage)</span>
          </div>
        </div>

        <!-- â•â• ANALYTICS â•â• -->
        <div id="analyticsSection" class="hidden">
          <div class="section-hero animate-in">
            <h1>ğŸ“Š <em>Analitik</em> Ujian</h1>
            <p>Statistik dan distribusi nilai peserta ujian</p>
          </div>
          <div id="analyticsContent" style="margin-top:16px;"></div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STUDENT MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="studentMode" class="hidden">

  <!-- LOGIN -->
  <div id="loginPage" class="exam-shell animate-in">
    <div class="login-card">
      <div class="login-hero">
        <div class="login-icon">ğŸ“</div>
        <h1 id="loginExamName">Ujian PGK Online</h1>
        <p id="loginSchoolName">SDN 2 Karangmangu</p>
      </div>
      <div class="login-info-grid">
        <div class="login-info-item">
          <div class="login-info-val" id="loginTotalQ">0</div>
          <div class="login-info-lbl">Soal PGK</div>
        </div>
        <div class="login-info-item">
          <div class="login-info-val"><span id="loginDuration">60</span>m</div>
          <div class="login-info-lbl">Durasi</div>
        </div>
        <div class="login-info-item">
          <div class="login-info-val" id="loginKKM">60</div>
          <div class="login-info-lbl">KKM</div>
        </div>
      </div>
      <div class="login-body">
        <div class="alert alert-warning">
          <span class="alert-icon">âš ï¸</span>
          <span><strong>Ujian PGK:</strong> Setiap soal bisa memiliki lebih dari satu jawaban benar. Pilih <strong>semua</strong> yang sesuai!</span>
        </div>
        <div class="form-group">
          <label class="form-label">Nama Lengkap</label>
          <input type="text" id="sName" class="form-control" placeholder="Masukkan nama lengkap...">
        </div>
        <div class="form-group" style="margin-bottom:24px">
          <label class="form-label">NIS / NIM</label>
          <input type="text" id="sId" class="form-control" placeholder="Masukkan NIS/NIM...">
        </div>
        <button class="btn btn-gold btn-lg btn-block" onclick="startExam()">Mulai Ujian â†’</button>
      </div>
    </div>
  </div>

  <!-- EXAM -->
  <div id="examPage" class="exam-shell hidden">
    <div class="timer-bar" id="timerBar">
      <div>
        <div class="timer-label">â³ Sisa Waktu</div>
        <div class="timer-val" id="timerDisp">60:00</div>
      </div>
      <div class="timer-icon">â°</div>
    </div>
    <div class="prog-meta">
      <span id="progLabel">Soal 1 dari 0</span>
      <span><strong id="progPct">0%</strong> selesai</span>
    </div>
    <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    <div class="q-wrap animate-in" id="qWrap">
      <!-- rendered by JS -->
    </div>
    <div class="nav-row">
      <button class="btn btn-ghost" id="prevBtn" onclick="navQ(-1)" disabled>â† Sebelumnya</button>
      <button class="btn btn-primary" id="nextBtn" onclick="navQ(1)">Selanjutnya â†’</button>
      <button class="btn btn-teal hidden" id="finishBtn" onclick="confirmFinish()">âœ… Selesai Ujian</button>
    </div>
  </div>

  <!-- RESULT -->
  <div id="resultPage" class="exam-shell hidden">
    <div class="login-card animate-in">
      <div class="result-hero">
        <div class="score-ring-wrap">
          <svg viewBox="0 0 120 120">
            <circle class="ring-bg" cx="60" cy="60" r="55"/>
            <circle class="ring-fill" id="ringFill" cx="60" cy="60" r="55"/>
          </svg>
          <div class="score-center">
            <div class="score-big" id="scoreNum">0</div>
            <div class="score-of">Nilai</div>
          </div>
        </div>
        <div class="result-status" id="resultStatus">â€”</div>
        <div class="result-sub" id="resultSub"></div>
      </div>
      <div class="result-grid" id="resultGrid"></div>
      <div style="padding:0 24px 20px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-teal" style="flex:2;justify-content:center" onclick="saveResult()">ğŸ’¾ Simpan ke Database</button>
        <button class="btn btn-ghost" style="flex:1;justify-content:center" onclick="downloadMyCSV()">ğŸ“¥ Download</button>
      </div>
      <div id="saveStatus" style="padding:0 24px 16px"></div>
      <div id="reviewSection"></div>
      <div style="padding:20px 24px 24px;border-top:1px solid var(--border)">
        <button class="btn btn-primary btn-block" onclick="resetExam()">ğŸ”„ Kembali ke Beranda</button>
      </div>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var questions = [];
var studentAnswers = {};   // { qIndex: Set of chosen option indices }
var currentQ = 0;
var timeLeft = 3600;
var timerHandle = null;
var examResult = null;
var resultsDB = [];
var LETTERS = ['A','B','C','D'];

var settings = {
  examName:     'Ujian PGK Semester 1',
  examSchool:   'SDN 2 Karangmangu',
  duration:     60,
  kkm:          60,
  scoringMode:  'partial'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function init(){
  loadFromLS();
  renderQuestionsEditor();
  updateSoalCount();
  updateDBCount();
  // load settings into form
  document.getElementById('examName').value    = settings.examName;
  document.getElementById('examSchool').value  = settings.examSchool;
  document.getElementById('examDuration').value= settings.duration;
  document.getElementById('examKKM').value     = settings.kkm;
  document.getElementById('scoringMode').value = settings.scoringMode;
})();

function loadFromLS(){
  try {
    var q = localStorage.getItem('pgk_questions'); if(q) questions = JSON.parse(q);
    var s = localStorage.getItem('pgk_settings');  if(s) Object.assign(settings, JSON.parse(s));
    var r = localStorage.getItem('pgk_results');   if(r) resultsDB = JSON.parse(r);
  } catch(e){}
}
function saveQuestionsToLS(){
  localStorage.setItem('pgk_questions', JSON.stringify(questions));
  updateSoalCount();
  showToast('âœ… Soal berhasil disimpan!', 'success');
}
function saveSettings(){
  settings.examName    = document.getElementById('examName').value.trim() || 'Ujian PGK';
  settings.examSchool  = document.getElementById('examSchool').value.trim();
  settings.duration    = parseInt(document.getElementById('examDuration').value) || 60;
  settings.kkm         = parseInt(document.getElementById('examKKM').value) || 60;
  settings.scoringMode = document.getElementById('scoringMode').value;
  localStorage.setItem('pgk_settings', JSON.stringify(settings));
  document.getElementById('settingsStatus').innerHTML = mkAlert('success','âœ…','Pengaturan disimpan!');
  setTimeout(()=>document.getElementById('settingsStatus').innerHTML='', 3000);
}
function updateSoalCount(){
  document.getElementById('soalCount').textContent = questions.length;
}
function updateDBCount(){
  document.getElementById('dbCount').textContent = resultsDB.length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODE SWITCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchMode(mode, el){
  document.querySelectorAll('.nav-pill-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  if(mode === 'admin'){
    document.getElementById('adminMode').classList.remove('hidden');
    document.getElementById('studentMode').classList.add('hidden');
    document.getElementById('topbarRight').innerHTML = '<span class="topbar-badge">ğŸ‘¤ Admin Mode</span>';
  } else {
    document.getElementById('adminMode').classList.add('hidden');
    document.getElementById('studentMode').classList.remove('hidden');
    document.getElementById('topbarRight').innerHTML = '<span class="topbar-badge" style="background:rgba(0,201,167,.15);border-color:rgba(0,201,167,.3);color:var(--teal)">ğŸ“ Mode Siswa</span>';
    resetExamUI();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN SECTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showAdminSection(name, el){
  ['soal','import','settings','database','analytics'].forEach(s=>{
    document.getElementById(s+'Section').classList.add('hidden');
  });
  document.querySelectorAll('.sidebar-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(name+'Section').classList.remove('hidden');
  el.classList.add('active');
  if(name==='database')  renderSheet();
  if(name==='analytics') renderAnalytics();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUESTION EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addQuestion(q){
  if(!q) q = {
    text:'', options:['','','',''],
    correctAnswers:[],
    explanation:''
  };
  questions.push(q);
  renderQuestionsEditor();
  updateSoalCount();
  // scroll to bottom
  setTimeout(()=>{ var els=document.querySelectorAll('.pgk-editor'); if(els.length) els[els.length-1].scrollIntoView({behavior:'smooth', block:'end'}); }, 100);
}

function removeQuestion(i){
  questions.splice(i,1);
  renderQuestionsEditor();
  updateSoalCount();
}

function renderQuestionsEditor(){
  var con = document.getElementById('questionsEditorContainer');
  if(!questions.length){
    con.innerHTML = '<div class="sheet-empty" style="padding:40px;background:white;border:1px solid var(--border);border-radius:var(--radius);"><div class="sheet-empty-icon">ğŸ“‹</div><div style="font-weight:600;color:var(--sub)">Belum ada soal. Klik "Tambah Soal" untuk mulai.</div></div>';
    return;
  }
  con.innerHTML = questions.map((q,i)=>`
    <div class="pgk-editor animate-in" id="qed_${i}">
      <div class="pgk-editor-head">
        <div class="pgk-q-num">${i+1}</div>
        <div style="flex:1">
          <span style="font-size:13px;font-weight:700;color:var(--text)">Soal ${i+1}</span>
          <span style="margin-left:8px" class="badge badge-purple">PGK</span>
          ${q.correctAnswers.length ? `<span class="badge badge-teal" style="margin-left:4px">${q.correctAnswers.length} jawaban benar</span>` : '<span class="badge badge-red" style="margin-left:4px">Pilih jawaban benar!</span>'}
        </div>
        <button class="btn btn-ghost btn-sm" onclick="removeQuestion(${i})" title="Hapus soal">ğŸ—‘</button>
      </div>
      <div class="pgk-editor-body">
        <div class="form-group">
          <label class="form-label">Teks Pertanyaan</label>
          <textarea class="form-control" rows="3" placeholder="Tulis pertanyaan di sini..." onchange="questions[${i}].text=this.value; renderQuestionsEditor()">${escHtml(q.text)}</textarea>
        </div>
        <div class="form-label" style="margin-bottom:12px">Opsi Jawaban <span style="color:var(--muted);font-weight:500;text-transform:none;letter-spacing:0">(âœ“ = jawaban benar)</span></div>
        ${q.options.map((opt,j)=>`
          <div class="pgk-option-row">
            <div class="pgk-option-letter" style="${q.correctAnswers.includes(j)?'background:var(--teal-lt);border-color:var(--teal-bd);color:#007a65':''}">
              ${LETTERS[j]}
            </div>
            <input type="checkbox" class="pgk-check" ${q.correctAnswers.includes(j)?'checked':''}
              onchange="toggleCorrect(${i},${j})">
            <input type="text" class="form-control" value="${escHtml(opt)}"
              placeholder="Teks opsi ${LETTERS[j]}..."
              oninput="questions[${i}].options[${j}]=this.value"
              style="flex:1">
          </div>
        `).join('')}
        <div class="form-group" style="margin-top:14px;margin-bottom:0">
          <label class="form-label">Penjelasan / Pembahasan (opsional)</label>
          <input type="text" class="form-control" placeholder="Jelaskan mengapa jawaban tersebut benar..."
            value="${escHtml(q.explanation||'')}"
            oninput="questions[${i}].explanation=this.value">
        </div>
      </div>
    </div>
  `).join('');
}

function toggleCorrect(qi, oi){
  var idx = questions[qi].correctAnswers.indexOf(oi);
  if(idx === -1) questions[qi].correctAnswers.push(oi);
  else questions[qi].correctAnswers.splice(idx,1);
  renderQuestionsEditor();
}

function clearAllQuestions(){
  if(!questions.length || confirm('Hapus semua soal?')){ questions=[]; renderQuestionsEditor(); updateSoalCount(); }
}

function loadSampleQuestions(){
  questions = [
    {
      text:'Manakah pernyataan yang benar tentang fotosintesis?',
      options:['Memerlukan cahaya matahari','Menghasilkan oksigen','Terjadi di mitokondria','Menyerap COâ‚‚ dari udara'],
      correctAnswers:[0,1,3],
      explanation:'Fotosintesis terjadi di kloroplas, memerlukan cahaya, menghasilkan Oâ‚‚, dan menyerap COâ‚‚.'
    },
    {
      text:'Manakah yang termasuk bilangan prima?',
      options:['2','9','13','15'],
      correctAnswers:[0,2],
      explanation:'2 dan 13 adalah bilangan prima. 9=3Ã—3, 15=3Ã—5.'
    },
    {
      text:'Nilai Pancasila yang sesuai dengan sila ke-3 adalah...',
      options:['Persatuan bangsa','Keadilan sosial','Gotong royong','Cinta tanah air'],
      correctAnswers:[0,2,3],
      explanation:'Sila ke-3 "Persatuan Indonesia" mencakup persatuan, gotong royong, dan cinta tanah air.'
    },
    {
      text:'Manakah yang merupakan fungsi tulang bagi tubuh manusia?',
      options:['Melindungi organ dalam','Tempat melekatnya otot','Menghasilkan sel darah merah','Menyimpan lemak'],
      correctAnswers:[0,1,2],
      explanation:'Tulang berfungsi melindungi organ, tempat otot melekat, dan memproduksi sel darah merah di sumsum tulang merah.'
    }
  ];
  renderQuestionsEditor();
  updateSoalCount();
  saveQuestionsToLS();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CSV IMPORT/EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('csvFileInput').addEventListener('change', function(e){
  var f = e.target.files[0];
  if(f) Papa.parse(f, {delimiter:';', header:true, skipEmptyLines:true, complete: r=>processCSVRows(r.data)});
});

function importCSV(){
  var txt = document.getElementById('csvTextInput').value.trim();
  if(!txt){ showStatus('importStatus','warning','âš ï¸','Paste CSV terlebih dahulu!'); return; }
  Papa.parse(txt, {delimiter:';', header:true, skipEmptyLines:true,
    complete: r=>processCSVRows(r.data),
    error: e=>showStatus('importStatus','danger','âŒ','Error: '+e.message)
  });
}

function processCSVRows(rows){
  var added = 0;
  rows.forEach(row=>{
    if(!row.soal) return;
    var correctRaw = (row.jawaban_benar||'').toString().split('|').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x));
    questions.push({
      text: row.soal,
      options: [row.opsi_a||'',row.opsi_b||'',row.opsi_c||'',row.opsi_d||''],
      correctAnswers: correctRaw,
      explanation: row.penjelasan||''
    });
    added++;
  });
  if(added){
    saveQuestionsToLS();
    renderQuestionsEditor();
    showStatus('importStatus','success','âœ…',`<strong>${added} soal</strong> berhasil diimport!`);
  } else {
    showStatus('importStatus','danger','âŒ','Tidak ada soal valid di CSV!');
  }
}

function exportQuestionsCSV(){
  var rows = [['soal','opsi_a','opsi_b','opsi_c','opsi_d','jawaban_benar','penjelasan']];
  questions.forEach(q=>{
    rows.push([q.text, ...q.options, q.correctAnswers.join('|'), q.explanation||'']);
  });
  var csv = rows.map(r=>r.map(c=>'"'+(c||'').toString().replace(/"/g,'""')+'"').join(';')).join('\n');
  dlFile(csv, 'soal_pgk_'+Date.now()+'.csv', 'text/csv');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATABASE / SPREADSHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSheet(){
  var sort = document.getElementById('sheetSort').value;
  var data = [...resultsDB];
  if(sort==='newest')     data.sort((a,b)=>b.ts-a.ts);
  if(sort==='score_desc') data.sort((a,b)=>b.score-a.score);
  if(sort==='score_asc')  data.sort((a,b)=>a.score-b.score);
  if(sort==='name')       data.sort((a,b)=>a.name.localeCompare(b.name));
  renderSheetRows(data);
  renderDBStats();
  updateDBCount();
}

function renderSheetRows(data){
  var body = document.getElementById('sheetBody');
  if(!data.length){
    body.innerHTML='<tr><td colspan="9"><div class="sheet-empty"><div class="sheet-empty-icon">ğŸ“­</div><div>Belum ada data ujian</div></div></td></tr>';
    document.getElementById('sheetCount').textContent='0 baris';
    return;
  }
  body.innerHTML = data.map((r,i)=>{
    var scoreColor = r.score>=80?'var(--teal)':r.score>=settings.kkm?'var(--gold-dk)':'var(--red)';
    var pass = r.score >= settings.kkm;
    var dt = new Date(r.ts);
    var dtStr = dt.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})+' '+dt.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
    var dur = r.timeTaken>=60 ? Math.floor(r.timeTaken/60)+'m '+(r.timeTaken%60)+'d' : r.timeTaken+'d';
    return `<tr data-name="${(r.name||'').toLowerCase()}" data-nis="${(r.nis||'').toLowerCase()}" data-status="${pass?'LULUS':'TIDAK LULUS'}">
      <td class="cell-id">${i+1}</td>
      <td class="cell-time">${dtStr}</td>
      <td><span class="cell-nim">${escHtml(r.nis)}</span></td>
      <td class="cell-name">${escHtml(r.name)}</td>
      <td><span class="cell-score" style="color:${scoreColor}">${r.score}</span></td>
      <td class="cell-answers">${r.correct} / ${r.total}</td>
      <td class="cell-answers">${r.total}</td>
      <td class="cell-time">${dur}</td>
      <td><span class="badge ${pass?'badge-teal':'badge-red'}">${pass?'âœ… Lulus':'âŒ Tidak'}</span></td>
    </tr>`;
  }).join('');
  document.getElementById('sheetCount').textContent = data.length+' baris';
}

function filterSheet(){
  var q = document.getElementById('sheetSearch').value.toLowerCase();
  var fs = document.getElementById('sheetFilterStatus').value;
  document.querySelectorAll('#sheetBody tr').forEach(row=>{
    if(!row.dataset.name) return;
    var show = (row.dataset.name.includes(q)||row.dataset.nis.includes(q))&&(!fs||row.dataset.status===fs);
    row.style.display = show?'':'none';
  });
}

function renderDBStats(){
  var el = document.getElementById('dbStats');
  if(!resultsDB.length){ el.innerHTML=''; return; }
  var scores = resultsDB.map(r=>r.score);
  var avg = Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);
  var lulus = resultsDB.filter(r=>r.score>=settings.kkm).length;
  var max = Math.max(...scores), min = Math.min(...scores);
  el.innerHTML = `<div class="grid-4">
    ${sc('ğŸ‘¥',resultsDB.length,'Peserta','var(--navy)')}
    ${sc('âœ…',lulus,'Lulus','var(--teal)')}
    ${sc('ğŸ“ˆ',avg,'Rata-rata','var(--gold-dk)')}
    ${sc('ğŸ†',max,'Tertinggi','#059669')}
  </div>`;
}

function sc(icon,val,lbl,color){
  return `<div class="stat-card"><div class="stat-card-stripe" style="background:${color}"></div><div class="stat-icon">${icon}</div><div class="stat-val" style="color:${color}">${val}</div><div class="stat-lbl">${lbl}</div></div>`;
}

function clearDatabase(){
  if(!resultsDB.length) return;
  if(confirm('Hapus semua data hasil ujian? Tindakan ini tidak bisa dibatalkan.')){ resultsDB=[]; saveResultsToDB(); renderSheet(); }
}

function exportResultsCSV(){
  if(!resultsDB.length){ showToast('Belum ada data!','warning'); return; }
  var rows=[['ID','Waktu','NIS','Nama','Nilai','Benar','Total','Durasi_detik','Status']];
  resultsDB.forEach((r,i)=>{
    rows.push([i+1,new Date(r.ts).toLocaleString('id-ID'),r.nis,r.name,r.score,r.correct,r.total,r.timeTaken,r.score>=settings.kkm?'LULUS':'TIDAK LULUS']);
  });
  var csv = rows.map(r=>r.map(c=>'"'+(c||'').toString().replace(/"/g,'""')+'"').join(';')).join('\n');
  dlFile(csv,'hasil_ujian_pgk_'+Date.now()+'.csv','text/csv');
}

function saveResultsToDB(){
  localStorage.setItem('pgk_results', JSON.stringify(resultsDB));
  updateDBCount();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAnalytics(){
  var el = document.getElementById('analyticsContent');
  if(!resultsDB.length){
    el.innerHTML=mkAlert('info','ğŸ“Š','Belum ada data untuk dianalisis.');
    return;
  }
  var scores = resultsDB.map(r=>r.score);
  var buckets = [{lbl:'0â€“20',min:0,max:20},{lbl:'21â€“40',min:21,max:40},{lbl:'41â€“60',min:41,max:60},{lbl:'61â€“80',min:61,max:80},{lbl:'81â€“100',min:81,max:100}];
  var dist = buckets.map(b=>({...b, count:scores.filter(s=>s>=b.min&&s<=b.max).length}));
  var maxCount = Math.max(...dist.map(d=>d.count),1);
  var avg = Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);
  var lulus = resultsDB.filter(r=>r.score>=settings.kkm).length;
  el.innerHTML = `
    <div class="grid-4" style="margin-bottom:16px">
      ${sc('ğŸ“Š',avg,'Rata-rata Nilai','var(--gold-dk)')}
      ${sc('âœ…',lulus,'Lulus','var(--teal)')}
      ${sc('âŒ',resultsDB.length-lulus,'Tidak Lulus','var(--red)')}
      ${sc('ğŸ“ˆ',Math.round(lulus/resultsDB.length*100)+'%','Persentase Lulus','#059669')}
    </div>
    <div class="card" style="padding:24px">
      <div class="card-title" style="font-size:14px;margin-bottom:20px">ğŸ“Š Distribusi Nilai</div>
      ${dist.map(d=>`
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
          <div style="width:60px;font-size:12px;font-weight:600;color:var(--sub)">${d.lbl}</div>
          <div style="flex:1;background:var(--border);border-radius:4px;height:28px;overflow:hidden">
            <div style="height:100%;width:${Math.round(d.count/maxCount*100)}%;background:linear-gradient(90deg,var(--gold),var(--teal));border-radius:4px;transition:width .6s;display:flex;align-items:center;padding-left:8px">
              ${d.count?`<span style="font-size:11px;font-weight:700;color:white">${d.count}</span>`:''}
            </div>
          </div>
          <div style="width:32px;font-size:12px;font-weight:700;color:var(--muted)">${d.count}</div>
        </div>
      `).join('')}
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STUDENT EXAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetExamUI(){
  studentAnswers = {}; currentQ = 0; examResult = null;
  if(timerHandle){ clearInterval(timerHandle); timerHandle=null; }
  ['loginPage','examPage','resultPage'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById('loginPage').classList.remove('hidden');
  // fill login info
  document.getElementById('loginExamName').textContent = settings.examName;
  document.getElementById('loginSchoolName').textContent = settings.examSchool;
  document.getElementById('loginTotalQ').textContent = questions.length;
  document.getElementById('loginDuration').textContent = settings.duration;
  document.getElementById('loginKKM').textContent = settings.kkm;
}

function startExam(){
  var name = document.getElementById('sName').value.trim();
  var nis  = document.getElementById('sId').value.trim();
  if(!name||!nis){ showToast('Lengkapi nama dan NIS!','warning'); return; }
  if(!questions.length){ showToast('Tidak ada soal! Admin belum mengupload soal.','warning'); return; }
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('examPage').classList.remove('hidden');
  timeLeft = settings.duration * 60;
  studentAnswers = {};
  currentQ = 0;
  startTimer();
  renderQ();
}

function startTimer(){
  timerHandle = setInterval(()=>{
    timeLeft--;
    var m = Math.floor(timeLeft/60), s = timeLeft%60;
    document.getElementById('timerDisp').textContent = (m<10?'0':'')+m+':'+(s<10?'0':'')+s;
    document.getElementById('timerBar').classList.toggle('warn', timeLeft<=300);
    if(timeLeft<=0){ clearInterval(timerHandle); finishExam(); }
  },1000);
}

function renderQ(){
  var q = questions[currentQ];
  var total = questions.length;
  var pct = Math.round((currentQ+1)/total*100);
  document.getElementById('progLabel').textContent = 'Soal '+(currentQ+1)+' dari '+total;
  document.getElementById('progPct').textContent = pct+'%';
  document.getElementById('progFill').style.width = pct+'%';
  document.getElementById('prevBtn').disabled = currentQ===0;
  var isLast = currentQ===total-1;
  document.getElementById('nextBtn').classList.toggle('hidden', isLast);
  document.getElementById('finishBtn').classList.toggle('hidden', !isLast);

  var chosen = studentAnswers[currentQ] || new Set();
  var html = `
    <div class="q-head">
      <span class="q-num-badge">ğŸ“Œ Soal ${currentQ+1} / ${total}</span>
      <span class="badge badge-purple">PGK</span>
      ${chosen.size ? `<span class="badge badge-teal">${chosen.size} dipilih</span>` : ''}
    </div>
    <div class="q-body">
      <div class="q-instruction">â˜‘ï¸ Pilih <strong>semua jawaban yang benar</strong> â€” bisa lebih dari satu!</div>
      <div class="q-text">${escHtml(q.text)}</div>
      <div class="pgk-options">
        ${q.options.map((opt,i)=>`
          <button class="pgk-opt ${chosen.has(i)?'checked':''}" onclick="toggleAnswer(${i})">
            <span class="pgk-opt-checkbox">${chosen.has(i)?'âœ“':''}</span>
            <span class="pgk-opt-letter">${LETTERS[i]}</span>
            <span class="pgk-opt-text">${escHtml(opt)}</span>
          </button>
        `).join('')}
      </div>
    </div>
  `;
  document.getElementById('qWrap').innerHTML = html;
}

function toggleAnswer(optIdx){
  if(!studentAnswers[currentQ]) studentAnswers[currentQ] = new Set();
  var s = studentAnswers[currentQ];
  if(s.has(optIdx)) s.delete(optIdx); else s.add(optIdx);
  renderQ();
}

function navQ(dir){
  currentQ += dir;
  if(currentQ<0) currentQ=0;
  if(currentQ>=questions.length) currentQ=questions.length-1;
  renderQ();
}

function confirmFinish(){
  var unanswered = questions.filter((_,i)=>!studentAnswers[i]||studentAnswers[i].size===0).length;
  var msg = unanswered>0 ? `Ada ${unanswered} soal belum dijawab. Yakin selesai?` : 'Yakin ingin menyelesaikan ujian?';
  if(confirm(msg)) finishExam();
}

function finishExam(){
  if(timerHandle){ clearInterval(timerHandle); timerHandle=null; }
  var timeTaken = settings.duration*60 - timeLeft;
  var totalScore = 0;
  var totalCorrect = 0;
  var details = [];

  questions.forEach((q,i)=>{
    var chosen = studentAnswers[i] ? [...studentAnswers[i]] : [];
    var correct = q.correctAnswers;
    var partScore = calcScore(chosen, correct, q.options.length);
    totalScore += partScore;
    var isFullCorrect = setEqual(new Set(chosen), new Set(correct));
    if(isFullCorrect) totalCorrect++;
    details.push({q, chosen, correct, partScore, isFullCorrect});
  });

  var finalScore = Math.round(totalScore / questions.length);
  var name = document.getElementById('sName').value.trim();
  var nis  = document.getElementById('sId').value.trim();
  examResult = {
    ts: Date.now(), name, nis, score: finalScore,
    correct: totalCorrect, total: questions.length,
    timeTaken, details
  };
  showResult(examResult);
}

function calcScore(chosen, correct, total){
  // Partial scoring
  if(settings.scoringMode==='strict'){
    return setEqual(new Set(chosen), new Set(correct)) ? 100 : 0;
  }
  // Partial: reward correct selections, penalize wrong ones
  var truePos = chosen.filter(c=>correct.includes(c)).length;
  var falsePos = chosen.filter(c=>!correct.includes(c)).length;
  var precision = correct.length ? (truePos/correct.length) : 0;
  var penalty = total>0 ? (falsePos/total) : 0;
  return Math.max(0, (precision - penalty)) * 100;
}

function setEqual(a,b){
  if(a.size!==b.size) return false;
  for(var v of a) if(!b.has(v)) return false;
  return true;
}

function showResult(res){
  document.getElementById('examPage').classList.add('hidden');
  document.getElementById('resultPage').classList.remove('hidden');

  var pass = res.score>=settings.kkm;
  var C = 2*Math.PI*55;
  var ring = document.getElementById('ringFill');
  ring.style.strokeDasharray=C; ring.style.strokeDashoffset=C;
  ring.className='ring-fill '+(res.score>=80?'clr-teal':pass?'clr-gold':'clr-red');
  setTimeout(()=>{ ring.style.strokeDashoffset=C-(res.score/100)*C; },120);

  document.getElementById('scoreNum').textContent=res.score;
  document.getElementById('resultStatus').textContent=res.score>=80?'Luar Biasa! ğŸ‰':pass?'Baik! ğŸ‘':'Perlu Belajar Lagi ğŸ“š';
  document.getElementById('resultSub').textContent=pass?'Selamat! Anda dinyatakan LULUS.':'Nilai belum mencapai KKM ('+settings.kkm+'). Semangat belajar!';

  var m=Math.floor(res.timeTaken/60), s=res.timeTaken%60;
  document.getElementById('resultGrid').innerHTML =
    rChip('ğŸ‘¤ Nama',res.name)+rChip('ğŸ†” NIS/NIM',res.nis)+
    rChip('âœ… Soal Benar Penuh',res.correct+' dari '+res.total)+rChip('â± Waktu',m+'m '+s+'d')+
    rChip('ğŸ† Status',pass?'<span class="badge badge-teal">LULUS</span>':'<span class="badge badge-red">TIDAK LULUS</span>')+
    rChip('ğŸ“Š KKM',settings.kkm);

  // Review section
  var rev = `<div class="detail-head">ğŸ“– Pembahasan Per Soal</div><div class="detail-table-wrap"><table class="detail-table">
    <thead><tr><th>No</th><th>Soal</th><th>Jawaban Anda</th><th>Jawaban Benar</th><th>Nilai</th></tr></thead><tbody>
    ${res.details.map((d,i)=>{
      var chosenLabels = d.chosen.map(c=>LETTERS[c]).join(', ')||'â€”';
      var correctLabels = d.correct.map(c=>LETTERS[c]).join(', ')||'â€”';
      var pct = Math.round(d.partScore);
      var color = pct===100?'var(--teal)':pct>0?'var(--gold-dk)':'var(--red)';
      return `<tr>
        <td style="color:var(--muted);font-size:11px">${i+1}</td>
        <td style="font-size:12.5px;max-width:200px">${escHtml(d.q.text)}${d.q.explanation?`<div style="margin-top:6px;font-size:11px;color:var(--sub);background:var(--surface);padding:6px 9px;border-radius:6px;border-left:3px solid var(--gold)">ğŸ’¡ ${escHtml(d.q.explanation)}</div>`:''}
        </td>
        <td style="font-size:12px;color:${d.isFullCorrect?'var(--teal)':'var(--red)'};font-weight:600">${chosenLabels}</td>
        <td style="font-size:12px;color:var(--teal);font-weight:700">${correctLabels}</td>
        <td style="font-weight:800;color:${color}">${pct}</td>
      </tr>`;
    }).join('')}
    </tbody></table></div>`;
  document.getElementById('reviewSection').innerHTML=rev;
}

function rChip(lbl,val){ return `<div class="result-chip"><div class="result-chip-lbl">${lbl}</div><div class="result-chip-val">${val}</div></div>`; }

function saveResult(){
  if(!examResult){ showToast('Tidak ada data!','warning'); return; }
  resultsDB.push(examResult);
  saveResultsToDB();
  document.getElementById('saveStatus').innerHTML = mkAlert('success','âœ…','Hasil berhasil disimpan ke database!');
  document.getElementById('saveDbBtn')&&(document.getElementById('saveDbBtn').textContent='âœ“ Tersimpan');
  setTimeout(()=>document.getElementById('saveStatus').innerHTML='',3000);
}

function downloadMyCSV(){
  if(!examResult) return;
  var rows=[['Nama','NIS','Nilai','Benar','Total','Durasi_detik','Status'],
    [examResult.name,examResult.nis,examResult.score,examResult.correct,examResult.total,examResult.timeTaken,examResult.score>=settings.kkm?'LULUS':'TIDAK LULUS']];
  examResult.details.forEach((d,i)=>{
    rows.push(['Soal '+(i+1),d.q.text.substring(0,50),'Dipilih: '+d.chosen.map(c=>LETTERS[c]).join('|'),'Benar: '+d.correct.map(c=>LETTERS[c]).join('|'),Math.round(d.partScore)]);
  });
  dlFile(rows.map(r=>r.map(c=>'"'+(c||'').toString().replace(/"/g,'""')+'"').join(';')).join('\n'), 'hasil_'+examResult.nis+'_'+Date.now()+'.csv','text/csv');
}

function resetExam(){
  resetExamUI();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(str){
  return (str||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function mkAlert(type,icon,msg){
  return `<div class="alert alert-${type}"><span class="alert-icon">${icon}</span><span>${msg}</span></div>`;
}
function showStatus(elId,type,icon,msg){
  document.getElementById(elId).innerHTML=mkAlert(type,icon,msg);
  setTimeout(()=>{var e=document.getElementById(elId);if(e)e.innerHTML='';},4000);
}
function dlFile(content, name, type){
  var a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([content],{type}));
  a.download=name; a.click();
}
function showToast(msg, type='info'){
  var t=document.createElement('div');
  t.style.cssText='position:fixed;bottom:24px;right:24px;z-index:9999;padding:12px 20px;border-radius:10px;font-family:Sora,sans-serif;font-size:13px;font-weight:600;box-shadow:0 6px 24px rgba(0,0,0,.18);animation:fadeUp .3s ease;';
  t.style.background=type==='success'?'var(--teal)':type==='warning'?'var(--gold)':'var(--navy)';
  t.style.color=type==='warning'?'var(--navy)':'white';
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2800);
}
</script>
</body>
</html>
