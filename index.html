<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PGK Ujian Online â€” SDN 2 Karangmangu</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --navy:#0d1b2a;--navy-2:#1b2d42;--navy-3:#243447;--navy-4:#2f4460;
  --gold:#f5a623;--gold-dk:#d4891a;--gold-lt:#fff8ec;--gold-bd:#fde8b0;
  --teal:#00c9a7;--teal-lt:#e6faf6;--teal-bd:#99e8d8;
  --red:#ff4d6d;--red-lt:#fff0f3;--red-bd:#ffb3c1;
  --green:#06d6a0;--green-lt:#e8faf5;--green-bd:#9ae8d1;
  --purple:#7c3aed;--purple-lt:#f5f0ff;--purple-bd:#c4b5fd;
  --blue:#3b82f6;--blue-lt:#eff6ff;--blue-bd:#bfdbfe;
  --white:#fff;--off-white:#f8f9fc;--surface:#f2f4f8;
  --border:#e4e8f0;--border2:#c8d0e0;
  --text:#0d1b2a;--sub:#4a5568;--muted:#8898a9;
  --shadow-sm:0 1px 4px rgba(13,27,42,.08);
  --shadow:0 4px 20px rgba(13,27,42,.12);
  --radius:14px;--radius-sm:9px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'Sora',sans-serif;background:var(--off-white);min-height:100vh;color:var(--text);line-height:1.6}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar{background:var(--navy);padding:0 28px;position:sticky;top:0;z-index:300;box-shadow:0 2px 20px rgba(0,0,0,.3)}
.topbar-inner{max-width:1100px;margin:0 auto;height:60px;display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand{display:flex;align-items:center;gap:10px}
.brand-mark{width:36px;height:36px;background:linear-gradient(135deg,var(--gold),var(--gold-dk));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;box-shadow:0 2px 12px rgba(245,166,35,.4)}
.brand-text{color:white;font-size:15px;font-weight:700;letter-spacing:-.02em}
.brand-text span{color:var(--gold)}
.brand-sub{color:rgba(255,255,255,.4);font-size:10.5px}
.nav-pill{display:flex;gap:3px;background:rgba(255,255,255,.08);border-radius:28px;padding:4px}
.np-btn{background:none;border:none;color:rgba(255,255,255,.5);font-family:'Sora',sans-serif;font-size:12px;font-weight:600;padding:7px 14px;border-radius:24px;cursor:pointer;transition:all .18s;white-space:nowrap}
.np-btn:hover{color:white}
.np-btn.active{background:var(--gold);color:var(--navy)}
.tbadge{font-size:11px;font-weight:700;padding:5px 12px;border-radius:20px;letter-spacing:.05em}

/* â”€â”€ LAYOUT â”€â”€ */
.shell{max-width:1100px;margin:0 auto;padding:24px 18px 60px}

/* â”€â”€ ADMIN GRID â”€â”€ */
.admin-grid{display:grid;grid-template-columns:210px 1fr;min-height:calc(100vh - 62px)}
.admin-sb{background:var(--navy);padding:20px 12px;display:flex;flex-direction:column;gap:3px}
.sb-label{font-size:9.5px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,.28);padding:6px 10px;margin-top:8px}
.sb-btn{display:flex;align-items:center;gap:9px;padding:10px 12px;border-radius:8px;background:none;border:none;cursor:pointer;font-family:'Sora',sans-serif;font-size:12.5px;font-weight:500;color:rgba(255,255,255,.5);text-align:left;transition:all .18s;width:100%}
.sb-btn:hover{background:rgba(255,255,255,.07);color:white}
.sb-btn.active{background:rgba(245,166,35,.18);color:var(--gold)}
.sb-icon{font-size:15px;width:18px;text-align:center}
.sb-count{margin-left:auto;background:rgba(245,166,35,.2);color:var(--gold);font-size:9.5px;font-weight:700;padding:2px 6px;border-radius:8px}
.admin-content{background:var(--off-white);overflow-y:auto}
.admin-inner{padding:24px;max-width:880px}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-sm);overflow:hidden}
.card-header{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;background:var(--surface)}
.card-title{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px}
.card-body{padding:24px}

/* â”€â”€ HERO â”€â”€ */
.sec-hero{background:linear-gradient(135deg,var(--navy),var(--navy-2));border-radius:var(--radius) var(--radius) 0 0;padding:28px 32px;color:white;position:relative;overflow:hidden}
.sec-hero::before{content:'';position:absolute;top:-40px;right:-40px;width:180px;height:180px;background:radial-gradient(circle,rgba(245,166,35,.15) 0%,transparent 70%);border-radius:50%}
.sec-hero h1{font-size:23px;font-weight:800;letter-spacing:-.03em;margin-bottom:4px}
.sec-hero h1 em{color:var(--gold);font-style:normal}
.sec-hero p{font-size:13px;color:rgba(255,255,255,.55)}

/* â”€â”€ STAT GRID â”€â”€ */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:16px}
.scard{background:var(--white);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px 18px;position:relative;overflow:hidden;transition:transform .15s}
.scard:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.scard-stripe{position:absolute;top:0;left:0;bottom:0;width:4px}
.sval{font-size:30px;font-weight:800;letter-spacing:-.04em;line-height:1}
.slbl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-top:5px}
.sicon{font-size:18px;margin-bottom:8px}

/* â”€â”€ BTNS â”€â”€ */
.btn{display:inline-flex;align-items:center;gap:7px;font-family:'Sora',sans-serif;font-size:13px;font-weight:600;padding:10px 20px;border-radius:var(--radius-sm);cursor:pointer;border:none;transition:all .18s;white-space:nowrap}
.btn-block{width:100%;justify-content:center}
.btn-lg{padding:13px 26px;font-size:14.5px;border-radius:var(--radius)}
.btn-sm{padding:7px 12px;font-size:11.5px;border-radius:7px}
.btn-navy{background:var(--navy);color:white;box-shadow:0 2px 10px rgba(13,27,42,.22)}
.btn-navy:hover{background:var(--navy-2);transform:translateY(-1px)}
.btn-navy:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold-dk));color:var(--navy);box-shadow:0 2px 12px rgba(245,166,35,.28)}
.btn-gold:hover{transform:translateY(-1px);box-shadow:0 4px 18px rgba(245,166,35,.42)}
.btn-gold:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-teal{background:var(--teal);color:white;box-shadow:0 2px 10px rgba(0,201,167,.22)}
.btn-teal:hover{background:#00b090;transform:translateY(-1px)}
.btn-ghost{background:transparent;color:var(--sub);border:1.5px solid var(--border)}
.btn-ghost:hover{border-color:var(--border2);background:var(--surface);color:var(--text)}
.btn-ghost:disabled{opacity:.5;cursor:not-allowed}
.btn-red{background:var(--red);color:white}
.btn-red:hover{filter:brightness(1.08);transform:translateY(-1px)}

/* â”€â”€ FORMS â”€â”€ */
.form-group{margin-bottom:16px}
.form-label{display:block;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);margin-bottom:6px}
.form-control{width:100%;padding:10px 13px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);font-family:'Sora',sans-serif;font-size:13px;color:var(--text);outline:none;transition:border-color .18s,box-shadow .18s}
.form-control:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(245,166,35,.1);background:white}
.form-control::placeholder{color:var(--muted)}
.form-control.mono{font-family:'JetBrains Mono',monospace;font-size:12px}
textarea.form-control{min-height:120px;resize:vertical;line-height:1.7}
select.form-control{cursor:pointer}

/* â”€â”€ ALERTS â”€â”€ */
.alert{padding:12px 15px;border-radius:9px;font-size:12.5px;font-weight:500;display:flex;gap:9px;align-items:flex-start;margin-bottom:12px;border:1.5px solid;line-height:1.6}
.alert-icon{font-size:14px;flex-shrink:0;margin-top:1px}
.alert-info{background:var(--blue-lt);color:#1e3a5f;border-color:var(--blue-bd)}
.alert-success{background:var(--green-lt);color:#065f46;border-color:var(--green-bd)}
.alert-warning{background:var(--gold-lt);color:#78350f;border-color:var(--gold-bd)}
.alert-danger{background:var(--red-lt);color:#9b1c31;border-color:var(--red-bd)}

/* â”€â”€ BADGE â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:700;letter-spacing:.05em;padding:3px 9px;border-radius:18px;text-transform:uppercase}
.badge-gold{background:var(--gold-lt);color:var(--gold-dk);border:1px solid var(--gold-bd)}
.badge-teal{background:var(--teal-lt);color:#007a65;border:1px solid var(--teal-bd)}
.badge-red{background:var(--red-lt);color:var(--red);border:1px solid var(--red-bd)}
.badge-green{background:var(--green-lt);color:#047857;border:1px solid var(--green-bd)}
.badge-purple{background:var(--purple-lt);color:var(--purple);border:1px solid var(--purple-bd)}
.badge-navy{background:rgba(13,27,42,.07);color:var(--navy);border:1px solid rgba(13,27,42,.15)}

.hidden{display:none!important}
.sep{height:1px;background:var(--border);margin:18px 0}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KONEKSI SHEETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.conn-status{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:8px;font-size:12.5px;font-weight:600;border:1.5px solid}
.conn-ok{background:var(--green-lt);color:#047857;border-color:var(--green-bd)}
.conn-err{background:var(--red-lt);color:var(--red);border-color:var(--red-bd)}
.conn-idle{background:var(--surface);color:var(--muted);border-color:var(--border)}
.conn-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.dot-ok{background:var(--green);animation:blink 2s infinite}
.dot-err{background:var(--red)}
.dot-idle{background:var(--muted)}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

.steps-list{counter-reset:step;display:flex;flex-direction:column;gap:0}
.step-item{display:flex;gap:12px;padding:14px 0;border-bottom:1px solid var(--border)}
.step-item:last-child{border-bottom:none}
.step-num{width:28px;height:28px;border-radius:50%;background:var(--navy);color:var(--gold);font-size:12px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.step-content{flex:1}
.step-title{font-size:13.5px;font-weight:700;color:var(--text);margin-bottom:3px}
.step-desc{font-size:12px;color:var(--sub);line-height:1.6}
.step-code{font-family:'JetBrains Mono',monospace;font-size:11.5px;background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px 12px;margin-top:8px;color:var(--navy);line-height:1.8;white-space:pre-wrap;word-break:break-all}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOAL EDITOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.qed{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:14px;transition:box-shadow .2s}
.qed:hover{box-shadow:var(--shadow-sm)}
.qed-head{display:flex;align-items:center;gap:10px;padding:12px 16px;background:white;border-bottom:1px solid var(--border)}
.qed-num{width:30px;height:30px;border-radius:7px;background:var(--navy);color:var(--gold);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;flex-shrink:0}
.qed-body{padding:16px}
.opt-row{display:flex;align-items:center;gap:9px;margin-bottom:9px}
.opt-letter{width:30px;height:30px;border-radius:6px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;border:1.5px solid var(--border);background:var(--surface);color:var(--muted);transition:all .15s}
.pgk-chk{width:18px;height:18px;border-radius:5px;flex-shrink:0;border:2px solid var(--border);background:white;cursor:pointer;appearance:none;-webkit-appearance:none;position:relative;transition:all .15s}
.pgk-chk:checked{background:var(--teal);border-color:var(--teal)}
.pgk-chk:checked::after{content:'âœ“';color:white;font-size:10px;font-weight:800;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPREADSHEET VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sheet-tb{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:12px}
.sheet-search{flex:1;min-width:150px;position:relative}
.ss-icon{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:13px;pointer-events:none}
.sheet-search .form-control{padding-left:28px}
.sheet-wrap{overflow:auto;border:1px solid var(--border);border-radius:var(--radius-sm);background:white;max-height:480px}
.stbl{width:100%;border-collapse:collapse;font-size:12px;min-width:820px}
.stbl thead tr{background:var(--navy);position:sticky;top:0;z-index:5}
.stbl th{padding:10px 13px;text-align:left;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:rgba(255,255,255,.6);white-space:nowrap;border-right:1px solid rgba(255,255,255,.07)}
.stbl td{padding:10px 13px;border-bottom:1px solid var(--border);vertical-align:middle}
.stbl tbody tr:hover td{background:rgba(245,166,35,.04)}
.stbl tbody tr:last-child td{border-bottom:none}
.cell-id{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--muted)}
.cell-score{font-size:15px;font-weight:800}
.cell-name{font-weight:600}
.cell-nim{font-family:'JetBrains Mono',monospace;font-size:10.5px;background:rgba(245,166,35,.1);color:var(--gold-dk);padding:2px 6px;border-radius:4px;display:inline-block}
.cell-time{font-size:10.5px;color:var(--muted)}
.sheet-empty{text-align:center;padding:48px 20px;color:var(--muted)}
.sheet-empty-icon{font-size:36px;margin-bottom:10px}

/* â”€â”€ SYNC INDICATOR â”€â”€ */
.sync-bar{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:14px;font-size:12px;font-weight:600;color:var(--sub)}
.sync-bar.syncing{background:#fffbeb;border-color:var(--gold-bd);color:#78350f}
.sync-bar.synced{background:var(--green-lt);border-color:var(--green-bd);color:#047857}
.sync-bar.error{background:var(--red-lt);border-color:var(--red-bd);color:var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STUDENT UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.exam-shell{max-width:700px;margin:0 auto;padding:20px 14px 56px}
.login-card{background:white;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;border:1px solid var(--border)}
.login-hero{background:linear-gradient(135deg,var(--navy),var(--navy-4));padding:36px 32px 28px;text-align:center;position:relative;overflow:hidden}
.login-hero::after{content:'';position:absolute;bottom:-28px;left:50%;transform:translateX(-50%);width:100px;height:50px;background:radial-gradient(ellipse,rgba(245,166,35,.18) 0%,transparent 70%)}
.login-icon{width:68px;height:68px;margin:0 auto 16px;background:linear-gradient(135deg,var(--gold),var(--gold-dk));border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:30px;box-shadow:0 6px 22px rgba(245,166,35,.35)}
.login-hero h1{font-size:24px;font-weight:800;color:white;letter-spacing:-.03em;margin-bottom:5px}
.login-hero p{font-size:13px;color:rgba(255,255,255,.5)}
.login-info{display:grid;grid-template-columns:repeat(3,1fr);border-bottom:1px solid var(--border)}
.li-item{padding:14px 18px;text-align:center;border-right:1px solid var(--border)}
.li-item:last-child{border-right:none}
.li-val{font-size:22px;font-weight:800;color:var(--navy);line-height:1}
.li-lbl{font-size:9.5px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);font-weight:600;margin-top:3px}
.login-body{padding:24px}

/* TIMER */
.timer-bar{background:linear-gradient(135deg,var(--navy),var(--navy-2));border-radius:11px;padding:13px 20px;display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;box-shadow:0 4px 14px rgba(13,27,42,.22);border:1px solid rgba(255,255,255,.07)}
.timer-bar.warn{background:linear-gradient(135deg,#c53030,#e53e3e)}
.timer-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:rgba(255,255,255,.5);margin-bottom:2px}
.timer-val{font-size:32px;font-weight:800;color:white;letter-spacing:.05em;font-variant-numeric:tabular-nums;font-family:'JetBrains Mono',monospace}
.timer-icon{font-size:24px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* PROGRESS */
.prog-meta{display:flex;justify-content:space-between;margin-bottom:5px}
.prog-meta span{font-size:11.5px;font-weight:600;color:var(--muted)}
.prog-meta strong{color:var(--gold-dk)}
.prog-track{height:5px;background:var(--border);border-radius:3px;margin-bottom:18px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--teal));border-radius:3px;transition:width .5s cubic-bezier(.23,1,.32,1)}

/* Q CARD */
.qwrap{background:white;border:1.5px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-sm)}
.qhead{padding:16px 22px;border-bottom:1px solid var(--border);background:var(--surface);display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.qnum{background:var(--navy);color:var(--gold);font-size:10.5px;font-weight:800;padding:4px 12px;border-radius:18px;white-space:nowrap}
.qbody{padding:22px}
.q-instr{background:linear-gradient(135deg,rgba(0,201,167,.08),rgba(0,201,167,.04));border:1px solid var(--teal-bd);border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:12px;font-weight:600;color:#007a65;display:flex;align-items:center;gap:7px}
.qtext{font-size:15.5px;font-weight:600;color:var(--text);line-height:1.7;margin-bottom:18px}
.pgk-opts{display:flex;flex-direction:column;gap:9px}
.pgk-opt{display:flex;align-items:flex-start;gap:12px;padding:13px 16px;border:2px solid var(--border);border-radius:9px;cursor:pointer;transition:all .18s;background:white;text-align:left;width:100%;font-family:'Sora',sans-serif}
.pgk-opt:hover{border-color:var(--gold-bd);background:var(--gold-lt)}
.pgk-opt.checked{border-color:var(--teal);background:var(--teal-lt)}
.opt-chkbox{width:20px;height:20px;border-radius:5px;flex-shrink:0;border:2px solid var(--border2);background:white;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;transition:all .15s;margin-top:1px}
.pgk-opt.checked .opt-chkbox{background:var(--teal);border-color:var(--teal);color:white}
.opt-ltr{width:26px;height:26px;flex-shrink:0;border-radius:6px;background:var(--surface);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:var(--muted);transition:all .15s}
.pgk-opt.checked .opt-ltr{background:rgba(0,201,167,.15);border-color:var(--teal-bd);color:#007a65}
.opt-txt{font-size:13.5px;font-weight:500;color:var(--text);line-height:1.55;flex:1}
.nav-row{display:flex;gap:9px;padding:18px 22px 22px}
.nav-row .btn{flex:1;justify-content:center}

/* RESULT */
.result-hero{background:linear-gradient(135deg,var(--navy),var(--navy-4));padding:32px;text-align:center;color:white;position:relative;overflow:hidden}
.result-hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 0%,rgba(245,166,35,.13) 0%,transparent 70%)}
.score-ring{position:relative;display:inline-block;margin-bottom:18px}
.score-ring svg{width:140px;height:140px;transform:rotate(-90deg)}
.score-ring circle{fill:none;stroke-width:10}
.ring-bg{stroke:rgba(255,255,255,.1)}
.ring-fill{stroke-linecap:round;stroke-dasharray:326;stroke-dashoffset:326;transition:stroke-dashoffset 1.8s cubic-bezier(.23,1,.32,1)}
.ring-fill.c-gold{stroke:var(--gold)}
.ring-fill.c-teal{stroke:var(--teal)}
.ring-fill.c-red{stroke:var(--red)}
.score-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.score-big{font-size:40px;font-weight:800;letter-spacing:-.04em;color:white;line-height:1}
.score-of{font-size:10.5px;color:rgba(255,255,255,.4);font-weight:600;text-transform:uppercase;letter-spacing:.08em}
.res-status{font-size:20px;font-weight:800;margin-bottom:5px}
.res-sub{font-size:13px;color:rgba(255,255,255,.52)}
.res-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:20px}
.rchip{background:var(--surface);border:1px solid var(--border);border-radius:9px;padding:12px 14px}
.rchip-lbl{font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px}
.rchip-val{font-size:15px;font-weight:700;color:var(--text)}
.dtbl{width:100%;border-collapse:collapse;font-size:12px}
.dtbl th{padding:9px 12px;background:var(--surface);border-bottom:2px solid var(--border);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);text-align:left}
.dtbl td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:top}
.dtbl tbody tr:last-child td{border-bottom:none}

/* SPINNER */
.spinner{display:inline-block;width:13px;height:13px;border:2px solid rgba(0,0,0,.1);border-top-color:currentColor;border-radius:50%;animation:spin .65s linear infinite;vertical-align:middle;margin-right:5px}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.ani{animation:fadeUp .4s ease both}

/* SHEET LIVE BADGE */
.live-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(6,214,160,.15);border:1px solid var(--green-bd);color:#047857;font-size:10.5px;font-weight:700;padding:4px 10px;border-radius:14px;letter-spacing:.04em}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:blink 1.5s infinite}

@media(max-width:768px){
  .admin-grid{grid-template-columns:1fr}
  .admin-sb{flex-direction:row;overflow-x:auto;padding:10px;gap:3px}
  .sb-label{display:none}
  .sb-btn{padding:9px 12px;min-width:max-content}
  .res-grid{grid-template-columns:1fr}
  .login-info{grid-template-columns:1fr}
  .nav-row{flex-wrap:wrap}
  .admin-inner{padding:14px}
  .shell{padding:14px 10px 40px}
  .topbar-inner{height:54px}
  .nav-pill{display:none}
}
</style>
</head>
<body>

<!-- â•â• TOPBAR â•â• -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="brand-mark">ğŸ“</div>
      <div>
        <div class="brand-text">PGK<span>Online</span></div>
        <div class="brand-sub">SDN 2 Karangmangu</div>
      </div>
    </div>
    <div class="nav-pill">
      <button class="np-btn active" onclick="switchMode('admin',this)">âš™ï¸ Admin</button>
      <button class="np-btn" onclick="switchMode('student',this)">ğŸ“ Ujian Siswa</button>
    </div>
    <div id="topbarRight">
      <span class="tbadge" style="background:rgba(245,166,35,.15);border:1px solid rgba(245,166,35,.3);color:var(--gold)">ğŸ‘¤ Admin</span>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ADMIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="adminMode">
  <div class="admin-grid">
    <div class="admin-sb">
      <div class="sb-label">SOAL</div>
      <button class="sb-btn active" onclick="showSec('soal',this)"><span class="sb-icon">ğŸ“</span>Buat Soal PGK<span class="sb-count" id="soalCount">0</span></button>
      <button class="sb-btn" onclick="showSec('import',this)"><span class="sb-icon">ğŸ“„</span>Import CSV</button>
      <div class="sb-label">KONEKSI</div>
      <button class="sb-btn" onclick="showSec('sheets',this)"><span class="sb-icon">ğŸ“Š</span>Google Sheets</button>
      <div class="sb-label">PENGATURAN</div>
      <button class="sb-btn" onclick="showSec('settings',this)"><span class="sb-icon">âš™ï¸</span>Pengaturan</button>
      <div class="sb-label">DATA</div>
      <button class="sb-btn" onclick="showSec('database',this)"><span class="sb-icon">ğŸ—„ï¸</span>Database Lokal<span class="sb-count" id="dbCount">0</span></button>
    </div>

    <div class="admin-content">
      <div class="admin-inner">

        <!-- â•â• SOAL â•â• -->
        <div id="soalSec">
          <div class="sec-hero ani">
            <h1>ğŸ“ Editor Soal <em>PGK</em></h1>
            <p>Pilihan Ganda Kompleks â€” satu soal bisa punya beberapa jawaban benar</p>
          </div>
          <div style="background:white;border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius) var(--radius);padding:18px;margin-bottom:18px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-gold" onclick="addQ()">ï¼‹ Tambah Soal</button>
              <button class="btn btn-ghost btn-sm" onclick="saveQLS()">ğŸ’¾ Simpan</button>
              <button class="btn btn-ghost btn-sm" onclick="loadSample()">âœ¨ Contoh Soal</button>
              <button class="btn btn-ghost btn-sm" onclick="clearAll()">ğŸ—‘ Hapus Semua</button>
            </div>
          </div>
          <div id="qedCon"></div>
          <button class="btn btn-gold btn-block" style="margin-top:8px" onclick="addQ()">ï¼‹ Tambah Soal Baru</button>
        </div>

        <!-- â•â• IMPORT â•â• -->
        <div id="importSec" class="hidden">
          <div class="sec-hero ani">
            <h1>ğŸ“„ Import Soal <em>CSV</em></h1>
            <p>Upload CSV â€” jawaban benar ganda dipisah tanda <code style="background:rgba(255,255,255,.15);padding:1px 5px;border-radius:3px">|</code></p>
          </div>
          <div class="card" style="margin-top:14px">
            <div class="card-body">
              <div class="alert alert-info">
                <span class="alert-icon">â„¹ï¸</span>
                <div>
                  <strong>Format CSV (pemisah titik koma `;`):</strong>
                  <div class="step-code" style="margin-top:8px">soal;opsi_a;opsi_b;opsi_c;opsi_d;jawaban_benar;penjelasan
Manakah yang benar?;Opsi A;Opsi B;Opsi C;Opsi D;0|2;A dan C karena...</div>
                  <div style="font-size:11.5px;color:var(--sub);margin-top:8px">* <strong>jawaban_benar</strong>: 0=A, 1=B, 2=C, 3=D &nbsp;|&nbsp; Pisah dengan <code>|</code> untuk multi-jawaban (contoh: <code>0|2</code>)</div>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Upload File CSV</label>
                <input type="file" id="csvFileIn" accept=".csv" class="form-control">
              </div>
              <div class="form-group">
                <label class="form-label">Atau Paste CSV</label>
                <textarea id="csvTextIn" class="form-control mono" placeholder="soal;opsi_a;opsi_b;opsi_c;opsi_d;jawaban_benar;penjelasan&#10;Contoh soal;A;B;C;D;0|1;Penjelasan..."></textarea>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-gold" style="flex:2;justify-content:center" onclick="doImport()">ğŸ“¥ Import Soal</button>
                <button class="btn btn-ghost" style="flex:1;justify-content:center" onclick="exportQCSV()">â¬† Export CSV</button>
              </div>
              <div id="importStatus" style="margin-top:10px"></div>
            </div>
          </div>
        </div>

        <!-- â•â• GOOGLE SHEETS â•â• -->
        <div id="sheetsSec" class="hidden">
          <div class="sec-hero ani">
            <h1>ğŸ“Š Koneksi <em>Google Sheets</em></h1>
            <p>Kirim hasil ujian secara live ke spreadsheet Google Anda</p>
          </div>

          <!-- STATUS KONEKSI -->
          <div style="margin-top:16px;margin-bottom:16px">
            <div id="connStatusEl" class="conn-status conn-idle">
              <div class="conn-dot dot-idle" id="connDot"></div>
              <span id="connText">Belum dikonfigurasi</span>
              <span id="connLiveBadge"></span>
            </div>
          </div>

          <!-- PANDUAN LANGKAH â•â• -->
          <div class="card" style="margin-bottom:16px">
            <div class="card-header"><div class="card-title">ğŸ“– Panduan Setup (4 Langkah)</div></div>
            <div class="card-body">
              <div class="steps-list">
                <div class="step-item">
                  <div class="step-num">1</div>
                  <div class="step-content">
                    <div class="step-title">Buka Google Sheets baru</div>
                    <div class="step-desc">Kunjungi <a href="https://sheets.google.com" target="_blank" style="color:var(--blue)">sheets.google.com</a> â†’ buat spreadsheet baru â†’ beri nama apa saja (misal: "Hasil Ujian PGK").</div>
                  </div>
                </div>
                <div class="step-item">
                  <div class="step-num">2</div>
                  <div class="step-content">
                    <div class="step-title">Buka Apps Script Editor</div>
                    <div class="step-desc">Di menu Google Sheets: <strong>Extensions â†’ Apps Script</strong> â†’ hapus kode lama â†’ paste kode dari file <strong>Code.gs</strong> yang sudah disertakan.</div>
                  </div>
                </div>
                <div class="step-item">
                  <div class="step-num">3</div>
                  <div class="step-content">
                    <div class="step-title">Deploy sebagai Web App</div>
                    <div class="step-desc">
                      Di Apps Script: <strong>Deploy â†’ New Deployment</strong><br>
                      â€¢ Type: <strong>Web app</strong><br>
                      â€¢ Execute as: <strong>Me</strong><br>
                      â€¢ Who has access: <strong>Anyone</strong><br>
                      â†’ Klik Deploy â†’ Authorize â†’ Copy URL
                    </div>
                    <div class="step-code">Contoh URL:
https://script.google.com/macros/s/AKfycb.../exec</div>
                  </div>
                </div>
                <div class="step-item">
                  <div class="step-num">4</div>
                  <div class="step-content">
                    <div class="step-title">Paste URL di bawah & Test Koneksi</div>
                    <div class="step-desc">Copy URL dari langkah 3, paste di kolom di bawah ini, lalu klik Simpan & Test.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- URL INPUT -->
          <div class="card">
            <div class="card-header"><div class="card-title">ğŸ”— URL Web App</div></div>
            <div class="card-body">
              <div class="form-group">
                <label class="form-label">Google Apps Script Web App URL</label>
                <input type="url" id="gasUrl" class="form-control mono" placeholder="https://script.google.com/macros/s/.../exec">
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-gold" style="flex:2;justify-content:center" id="saveUrlBtn" onclick="saveAndTestUrl()">ğŸ’¾ Simpan & Test Koneksi</button>
                <button class="btn btn-ghost" style="flex:1;justify-content:center" onclick="testConnection()">ğŸ”„ Test Ulang</button>
              </div>
              <div id="urlTestResult" style="margin-top:10px"></div>

              <div class="sep"></div>

              <div class="alert alert-warning">
                <span class="alert-icon">âš ï¸</span>
                <div>
                  <strong>Catatan CORS:</strong> Karena Google Apps Script menggunakan redirect 302, pengiriman data menggunakan mode <code>no-cors</code> (data tetap terkirim, tapi response tidak bisa dibaca langsung). Solusi: tambahkan kolom "Status Sinkronisasi" di spreadsheet, atau gunakan tombol <strong>Refresh Data</strong> di dashboard untuk verifikasi.
                </div>
              </div>

              <!-- SYNC OPTIONS -->
              <div class="form-group" style="margin-top:4px">
                <label class="form-label">Mode Sinkronisasi</label>
                <select id="syncMode" class="form-control" onchange="saveSyncMode()">
                  <option value="auto">ğŸ”„ Otomatis â€” kirim langsung saat ujian selesai</option>
                  <option value="manual">âœ‹ Manual â€” siswa klik tombol "Simpan ke Sheets"</option>
                </select>
              </div>

              <div id="syncStatus" style="margin-top:8px"></div>
            </div>
          </div>

          <!-- LIVE DASHBOARD PULL -->
          <div class="card" style="margin-top:14px">
            <div class="card-header">
              <div class="card-title">ğŸ“Š Tarik Data dari Sheets</div>
              <button class="btn btn-teal btn-sm" onclick="pullFromSheets()">ğŸ”„ Refresh dari Sheets</button>
            </div>
            <div class="card-body" id="pullResult">
              <div style="text-align:center;color:var(--muted);font-size:13px;padding:20px">Klik "Refresh dari Sheets" untuk menarik data terbaru.</div>
            </div>
          </div>
        </div>

        <!-- â•â• SETTINGS â•â• -->
        <div id="settingsSec" class="hidden">
          <div class="sec-hero ani">
            <h1>âš™ï¸ <em>Pengaturan</em> Ujian</h1>
            <p>Konfigurasi ujian, durasi, dan penilaian PGK</p>
          </div>
          <div class="card" style="margin-top:14px">
            <div class="card-body">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
                <div class="form-group">
                  <label class="form-label">Nama Ujian</label>
                  <input type="text" id="cfgName" class="form-control" value="Ujian PGK Semester 1">
                </div>
                <div class="form-group">
                  <label class="form-label">Nama Sekolah</label>
                  <input type="text" id="cfgSchool" class="form-control" value="SDN 2 Karangmangu">
                </div>
                <div class="form-group">
                  <label class="form-label">Durasi (menit)</label>
                  <input type="number" id="cfgDur" class="form-control" value="60" min="5" max="300">
                </div>
                <div class="form-group">
                  <label class="form-label">KKM</label>
                  <input type="number" id="cfgKKM" class="form-control" value="60" min="0" max="100">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Mode Penilaian PGK</label>
                <select id="cfgScoring" class="form-control">
                  <option value="partial">Parsial â€” poin proporsional (pilih sebagian = dapat sebagian poin)</option>
                  <option value="strict">Ketat â€” harus semua jawaban tepat untuk dapat poin</option>
                </select>
              </div>
              <button class="btn btn-gold btn-block btn-lg" onclick="saveSettings()">ğŸ’¾ Simpan Pengaturan</button>
              <div id="cfgStatus" style="margin-top:10px"></div>
            </div>
          </div>
        </div>

        <!-- â•â• DATABASE LOKAL â•â• -->
        <div id="databaseSec" class="hidden">
          <div class="sec-hero ani">
            <h1>ğŸ—„ï¸ <em>Database</em> Lokal</h1>
            <p>Hasil tersimpan di browser â€” export CSV atau sync ke Google Sheets</p>
          </div>
          <div id="localDbStats" style="margin-top:14px;margin-bottom:12px"></div>
          <div class="sheet-tb">
            <div class="sheet-search"><span class="ss-icon">ğŸ”</span><input type="text" id="lsSearch" class="form-control" placeholder="Cari nama, NIS..." oninput="filterLocal()"></div>
            <select class="form-control" id="lsFilterSt" onchange="filterLocal()" style="width:auto;min-width:120px">
              <option value="">Semua Status</option>
              <option value="LULUS">âœ… Lulus</option>
              <option value="TIDAK LULUS">âŒ Tidak Lulus</option>
            </select>
            <select class="form-control" id="lsSort" onchange="renderLocal()" style="width:auto;min-width:120px">
              <option value="newest">Terbaru</option>
              <option value="score_desc">Nilai Tertinggi</option>
              <option value="score_asc">Nilai Terendah</option>
              <option value="name">Nama A-Z</option>
            </select>
            <button class="btn btn-teal btn-sm" onclick="exportLocalCSV()">ğŸ“¥ Export CSV</button>
            <button class="btn btn-ghost btn-sm" onclick="syncAllToSheets()">â˜ Sync ke Sheets</button>
            <button class="btn btn-ghost btn-sm" onclick="clearLocal()">ğŸ—‘</button>
          </div>
          <div id="syncAllStatus" style="margin-bottom:8px"></div>
          <div class="sheet-wrap">
            <table class="stbl">
              <thead>
                <tr>
                  <th style="width:32px">#</th>
                  <th>ğŸ• Waktu</th>
                  <th>ğŸ†” NIS</th>
                  <th>ğŸ‘¤ Nama</th>
                  <th>ğŸ“Š Nilai</th>
                  <th>âœ… Benar</th>
                  <th>â± Durasi</th>
                  <th>ğŸ† Status</th>
                  <th>â˜ Sheets</th>
                </tr>
              </thead>
              <tbody id="localBody">
                <tr><td colspan="9"><div class="sheet-empty"><div class="sheet-empty-icon">ğŸ“­</div><div>Belum ada data</div></div></td></tr>
              </tbody>
            </table>
          </div>
          <div style="margin-top:8px;font-size:11px;color:var(--muted);display:flex;justify-content:space-between">
            <span id="localCount">0 baris</span>
            <span>localStorage browser â€” hapus browser data = data hilang</span>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STUDENT MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="studentMode" class="hidden">

  <!-- LOGIN -->
  <div id="loginPage" class="exam-shell ani">
    <div class="login-card">
      <div class="login-hero">
        <div class="login-icon">ğŸ“</div>
        <h1 id="loginName">Ujian PGK Online</h1>
        <p id="loginSchool">SDN 2 Karangmangu</p>
      </div>
      <div class="login-info">
        <div class="li-item"><div class="li-val" id="loginTotalQ">0</div><div class="li-lbl">Soal PGK</div></div>
        <div class="li-item"><div class="li-val"><span id="loginDur">60</span>m</div><div class="li-lbl">Durasi</div></div>
        <div class="li-item"><div class="li-val" id="loginKKM">60</div><div class="li-lbl">KKM</div></div>
      </div>
      <div class="login-body">
        <div class="alert alert-warning">
          <span class="alert-icon">âš ï¸</span>
          <span><strong>PGK:</strong> Setiap soal bisa memiliki <strong>lebih dari satu jawaban benar</strong>. Pilih semua yang sesuai!</span>
        </div>
        <div class="form-group">
          <label class="form-label">Nama Lengkap</label>
          <input type="text" id="sName" class="form-control" placeholder="Masukkan nama lengkap...">
        </div>
        <div class="form-group" style="margin-bottom:22px">
          <label class="form-label">NIS / NIM</label>
          <input type="text" id="sId" class="form-control" placeholder="Masukkan NIS/NIM...">
        </div>
        <button class="btn btn-gold btn-lg btn-block" onclick="startExam()">Mulai Ujian â†’</button>
      </div>
    </div>
  </div>

  <!-- EXAM -->
  <div id="examPage" class="exam-shell hidden">
    <div class="timer-bar" id="timerBar">
      <div><div class="timer-label">â³ Sisa Waktu</div><div class="timer-val" id="timerDisp">60:00</div></div>
      <div class="timer-icon">â°</div>
    </div>
    <div class="prog-meta"><span id="progLbl">Soal 1 dari 0</span><span><strong id="progPct">0%</strong> selesai</span></div>
    <div class="prog-track"><div class="prog-fill" id="progFill"></div></div>
    <div class="qwrap ani" id="qwrap"></div>
    <div class="nav-row">
      <button class="btn btn-ghost" id="prevBtn" onclick="navQ(-1)" disabled>â† Sebelumnya</button>
      <button class="btn btn-navy" id="nextBtn" onclick="navQ(1)">Selanjutnya â†’</button>
      <button class="btn btn-teal hidden" id="finishBtn" onclick="confirmFinish()">âœ… Selesai Ujian</button>
    </div>
  </div>

  <!-- RESULT -->
  <div id="resultPage" class="exam-shell hidden">
    <div class="login-card ani">
      <div class="result-hero">
        <div class="score-ring">
          <svg viewBox="0 0 120 120">
            <circle class="ring-bg" cx="60" cy="60" r="52"/>
            <circle class="ring-fill" id="ringFill" cx="60" cy="60" r="52"/>
          </svg>
          <div class="score-center">
            <div class="score-big" id="scoreNum">0</div>
            <div class="score-of">Nilai</div>
          </div>
        </div>
        <div class="res-status" id="resStatus">â€”</div>
        <div class="res-sub" id="resSub"></div>
      </div>

      <!-- SYNC STATUS untuk siswa -->
      <div id="syncStudentBar" style="padding:12px 20px;border-bottom:1px solid var(--border)"></div>

      <div class="res-grid" id="resGrid"></div>
      <div style="padding:0 20px 16px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-gold" style="flex:2;justify-content:center" id="saveSheetBtn" onclick="saveToSheets()">â˜ Simpan ke Google Sheets</button>
        <button class="btn btn-ghost" style="flex:1;justify-content:center" onclick="dlMyCSV()">ğŸ“¥ CSV</button>
      </div>
      <div id="saveStatus" style="padding:0 20px 14px"></div>
      <div id="reviewSec"></div>
      <div style="padding:18px 20px 22px;border-top:1px solid var(--border)">
        <button class="btn btn-navy btn-block" onclick="resetExam()">ğŸ”„ Kembali ke Beranda</button>
      </div>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var questions=[], answers={}, curQ=0, timeLeft=3600, timerH=null, examResult=null, localDB=[];
var LETTERS=['A','B','C','D'];
var cfg={examName:'Ujian PGK Semester 1',examSchool:'SDN 2 Karangmangu',duration:60,kkm:60,scoringMode:'partial'};
var GAS_URL='';
var SYNC_MODE='auto';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  loadLS();
  renderQed();
  updateCounts();
  fillSettingsForm();
  document.getElementById('cfgName').value   = cfg.examName;
  document.getElementById('cfgSchool').value = cfg.examSchool;
  document.getElementById('cfgDur').value    = cfg.duration;
  document.getElementById('cfgKKM').value    = cfg.kkm;
  document.getElementById('cfgScoring').value= cfg.scoringMode;
  if(GAS_URL){ document.getElementById('gasUrl').value=GAS_URL; updateConnUI('idle','URL tersimpan. Klik Test Koneksi untuk verifikasi.'); }
  document.getElementById('syncMode').value = SYNC_MODE;
})();

function loadLS(){
  try{
    var q=localStorage.getItem('pgk_q');     if(q) questions=JSON.parse(q);
    var c=localStorage.getItem('pgk_cfg');   if(c) Object.assign(cfg,JSON.parse(c));
    var r=localStorage.getItem('pgk_res');   if(r) localDB=JSON.parse(r);
    var u=localStorage.getItem('pgk_gasurl');if(u) GAS_URL=u;
    var s=localStorage.getItem('pgk_sync');  if(s) SYNC_MODE=s;
  }catch(e){}
}
function saveQLS(){ localStorage.setItem('pgk_q',JSON.stringify(questions)); updateCounts(); toast('âœ… Soal disimpan!','success'); }
function saveSettings(){
  cfg.examName   = document.getElementById('cfgName').value.trim()||'Ujian PGK';
  cfg.examSchool = document.getElementById('cfgSchool').value.trim();
  cfg.duration   = parseInt(document.getElementById('cfgDur').value)||60;
  cfg.kkm        = parseInt(document.getElementById('cfgKKM').value)||60;
  cfg.scoringMode= document.getElementById('cfgScoring').value;
  localStorage.setItem('pgk_cfg',JSON.stringify(cfg));
  showSt('cfgStatus','success','âœ…','Pengaturan disimpan!');
}
function saveSyncMode(){ SYNC_MODE=document.getElementById('syncMode').value; localStorage.setItem('pgk_sync',SYNC_MODE); }
function updateCounts(){ document.getElementById('soalCount').textContent=questions.length; document.getElementById('dbCount').textContent=localDB.length; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODE SWITCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchMode(m,el){
  document.querySelectorAll('.np-btn').forEach(b=>b.classList.remove('active')); el.classList.add('active');
  if(m==='admin'){
    document.getElementById('adminMode').classList.remove('hidden');
    document.getElementById('studentMode').classList.add('hidden');
    document.getElementById('topbarRight').innerHTML='<span class="tbadge" style="background:rgba(245,166,35,.15);border:1px solid rgba(245,166,35,.3);color:var(--gold)">ğŸ‘¤ Admin</span>';
  } else {
    document.getElementById('adminMode').classList.add('hidden');
    document.getElementById('studentMode').classList.remove('hidden');
    document.getElementById('topbarRight').innerHTML='<span class="tbadge" style="background:rgba(0,201,167,.12);border:1px solid rgba(0,201,167,.3);color:var(--teal)">ğŸ“ Mode Siswa</span>';
    resetExamUI();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN SECTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSec(name,el){
  ['soal','import','sheets','settings','database'].forEach(s=>document.getElementById(s+'Sec').classList.add('hidden'));
  document.querySelectorAll('.sb-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(name+'Sec').classList.remove('hidden');
  el.classList.add('active');
  if(name==='database') renderLocal();
  if(name==='sheets'){ if(GAS_URL) document.getElementById('gasUrl').value=GAS_URL; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOOGLE SHEETS CONNECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveAndTestUrl(){
  var url = document.getElementById('gasUrl').value.trim();
  if(!url){ showSt('urlTestResult','warning','âš ï¸','Masukkan URL terlebih dahulu!'); return; }
  GAS_URL=url; localStorage.setItem('pgk_gasurl',url);
  testConnection();
}

function testConnection(){
  if(!GAS_URL){ showSt('urlTestResult','warning','âš ï¸','URL belum disimpan!'); return; }
  updateConnUI('testing','Menguji koneksi...');
  document.getElementById('urlTestResult').innerHTML=mkA('info','','<span class="spinner"></span> Menghubungi server...');
  fetch(GAS_URL+'?action=ping')
    .then(r=>r.json())
    .then(d=>{
      if(d.success||d.message){
        updateConnUI('ok','Terhubung ke Google Sheets âœ…');
        showSt('urlTestResult','success','âœ…','Koneksi berhasil! Server aktif: '+d.message);
        return fetch(GAS_URL+'?action=getSummary');
      } else throw new Error('Response tidak valid');
    })
    .then(r=>r.json())
    .then(s=>{
      showSt('urlTestResult','success','âœ…','Koneksi OK! Total data di Sheets: <strong>'+s.total+'</strong> baris');
    })
    .catch(err=>{
      // Jika CORS error, URL mungkin masih valid tapi browser blokir respons
      if(GAS_URL.includes('script.google.com')){
        updateConnUI('ok','URL tersimpan (CORS terbatas â€” data tetap terkirim saat ujian)');
        showSt('urlTestResult','warning','âš ï¸','URL tersimpan. Koneksi tidak bisa di-test langsung dari browser (CORS). Data ujian tetap akan terkirim via no-cors.');
      } else {
        updateConnUI('err','Koneksi gagal: '+err.message);
        showSt('urlTestResult','danger','âŒ','Gagal: '+err.message);
      }
    });
}

function updateConnUI(state, msg){
  var el=document.getElementById('connStatusEl'), dot=document.getElementById('connDot'), txt=document.getElementById('connText'), lb=document.getElementById('connLiveBadge');
  el.className='conn-status '; dot.className='conn-dot ';
  if(state==='ok'){ el.classList.add('conn-ok'); dot.classList.add('dot-ok'); lb.innerHTML='<span class="live-badge"><div class="live-dot"></div>LIVE</span>'; }
  else if(state==='err'){ el.classList.add('conn-err'); dot.classList.add('dot-err'); lb.innerHTML=''; }
  else { el.classList.add('conn-idle'); dot.classList.add('dot-idle'); lb.innerHTML=''; }
  txt.textContent=msg;
}

function pullFromSheets(){
  if(!GAS_URL){ document.getElementById('pullResult').innerHTML=mkA('warning','âš ï¸','URL belum dikonfigurasi!'); return; }
  document.getElementById('pullResult').innerHTML=mkA('info','','<span class="spinner"></span> Menarik data dari Google Sheets...');
  fetch(GAS_URL+'?action=getSummary')
    .then(r=>r.json())
    .then(s=>{
      return fetch(GAS_URL+'?action=getData').then(r=>r.json()).then(d=>({summary:s, data:d}));
    })
    .then(({summary:s, data:d})=>{
      var rows = d.data||[];
      var html = '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px">'+
        sc('ğŸ‘¥',s.total,'Total','var(--navy)')+sc('âœ…',s.lulus,'Lulus','var(--teal)')+
        sc('ğŸ“ˆ',s.rata_nilai,'Rata-rata','var(--gold-dk)')+sc('ğŸ†',s.nilai_tertinggi,'Tertinggi','#059669')+
        '</div>';
      if(rows.length){
        html+='<div class="sheet-wrap"><table class="stbl"><thead><tr><th>#</th><th>Waktu</th><th>NIS</th><th>Nama</th><th>Nilai</th><th>Status</th></tr></thead><tbody>';
        rows.forEach((r,i)=>{
          var pass=r['Status']==='LULUS';
          html+=`<tr><td class="cell-id">${i+1}</td><td class="cell-time">${r['Timestamp']||''}</td><td><span class="cell-nim">${esc(r['NIS/NIM']||'')}</span></td><td class="cell-name">${esc(r['Nama Siswa']||'')}</td><td class="cell-score" style="color:${r['Nilai']>=80?'var(--teal)':pass?'var(--gold-dk)':'var(--red)'}">${r['Nilai']||0}</td><td><span class="badge ${pass?'badge-teal':'badge-red'}">${pass?'âœ… Lulus':'âŒ Tidak'}</span></td></tr>`;
        });
        html+='</tbody></table></div>';
      } else { html+=mkA('info','â„¹ï¸','Belum ada data di Google Sheets.'); }
      document.getElementById('pullResult').innerHTML=html;
    })
    .catch(err=>{ document.getElementById('pullResult').innerHTML=mkA('danger','âŒ','Gagal menarik data: '+err.message); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEND TO SHEETS (no-cors trick)
//  Kirim sebagai text/plain, bukan application/json
//  agar bypass CORS preflight di Apps Script
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sendToSheets(data, onDone){
  if(!GAS_URL){ if(onDone) onDone(false,'URL tidak dikonfigurasi'); return; }
  var payload = JSON.stringify({...data, examName:cfg.examName, examSchool:cfg.examSchool, kkm:cfg.kkm});
  fetch(GAS_URL, {
    method:'POST',
    mode:'no-cors',
    headers:{'Content-Type':'text/plain'},
    body: payload
  })
  .then(()=>{ if(onDone) onDone(true,'Terkirim!'); })
  .catch(err=>{ if(onDone) onDone(false, err.message); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SYNC ALL LOCAL TO SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncAllToSheets(){
  if(!GAS_URL){ showSt('syncAllStatus','warning','âš ï¸','URL Google Sheets belum dikonfigurasi!'); return; }
  var unsynced = localDB.filter(r=>!r.synced);
  if(!unsynced.length){ showSt('syncAllStatus','info','â„¹ï¸','Semua data sudah tersinkron!'); return; }
  showSt('syncAllStatus','info','','<span class="spinner"></span> Menyinkronkan '+unsynced.length+' data...');
  var done=0;
  unsynced.forEach(r=>{
    sendToSheets(r, ok=>{
      if(ok){ r.synced=true; }
      done++;
      if(done===unsynced.length){
        localStorage.setItem('pgk_res',JSON.stringify(localDB));
        renderLocal();
        showSt('syncAllStatus','success','âœ…','Selesai! '+unsynced.length+' data dikirim ke Google Sheets.');
      }
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUESTION EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addQ(q){
  if(!q) q={text:'',options:['','','',''],correctAnswers:[],explanation:''};
  questions.push(q); renderQed(); updateCounts();
  setTimeout(()=>{var es=document.querySelectorAll('.qed');if(es.length)es[es.length-1].scrollIntoView({behavior:'smooth',block:'end'});},80);
}
function removeQ(i){ questions.splice(i,1); renderQed(); updateCounts(); }
function toggleCorrect(qi,oi){
  var idx=questions[qi].correctAnswers.indexOf(oi);
  if(idx===-1) questions[qi].correctAnswers.push(oi);
  else questions[qi].correctAnswers.splice(idx,1);
  renderQed();
}
function fillSettingsForm(){} // handled inline

function renderQed(){
  var con=document.getElementById('qedCon');
  if(!questions.length){
    con.innerHTML='<div class="sheet-empty" style="padding:40px;background:white;border:1px solid var(--border);border-radius:var(--radius)"><div class="sheet-empty-icon">ğŸ“‹</div><div style="font-weight:600;color:var(--sub)">Belum ada soal. Klik "Tambah Soal".</div></div>';
    return;
  }
  con.innerHTML=questions.map((q,i)=>`
    <div class="qed ani">
      <div class="qed-head">
        <div class="qed-num">${i+1}</div>
        <div style="flex:1">
          <span style="font-size:12.5px;font-weight:700">Soal ${i+1}</span>
          <span class="badge badge-purple" style="margin-left:6px">PGK</span>
          ${q.correctAnswers.length?`<span class="badge badge-teal" style="margin-left:4px">${q.correctAnswers.length} benar</span>`:'<span class="badge badge-red" style="margin-left:4px">Tandai jawaban!</span>'}
        </div>
        <button class="btn btn-ghost btn-sm" onclick="removeQ(${i})">ğŸ—‘</button>
      </div>
      <div class="qed-body">
        <div class="form-group">
          <label class="form-label">Pertanyaan</label>
          <textarea class="form-control" rows="2" placeholder="Tulis pertanyaan..." onchange="questions[${i}].text=this.value;renderQed()">${esc(q.text)}</textarea>
        </div>
        <div class="form-label" style="margin-bottom:10px">Opsi <span style="color:var(--muted);font-weight:400;text-transform:none;letter-spacing:0">(centang = jawaban benar)</span></div>
        ${q.options.map((opt,j)=>`
          <div class="opt-row">
            <div class="opt-letter" style="${q.correctAnswers.includes(j)?'background:var(--teal-lt);border-color:var(--teal-bd);color:#007a65':''}">${LETTERS[j]}</div>
            <input type="checkbox" class="pgk-chk" ${q.correctAnswers.includes(j)?'checked':''} onchange="toggleCorrect(${i},${j})">
            <input type="text" class="form-control" value="${esc(opt)}" placeholder="Teks opsi ${LETTERS[j]}..." oninput="questions[${i}].options[${j}]=this.value" style="flex:1">
          </div>
        `).join('')}
        <div class="form-group" style="margin-top:12px;margin-bottom:0">
          <label class="form-label">Penjelasan (opsional)</label>
          <input type="text" class="form-control" placeholder="Jelaskan jawaban yang benar..." value="${esc(q.explanation||'')}" oninput="questions[${i}].explanation=this.value">
        </div>
      </div>
    </div>
  `).join('');
}

function clearAll(){ if(!questions.length||confirm('Hapus semua soal?')){ questions=[]; renderQed(); updateCounts(); } }

function loadSample(){
  questions=[
    {text:'Manakah pernyataan yang benar tentang fotosintesis?',options:['Memerlukan cahaya matahari','Menghasilkan oksigen','Terjadi di mitokondria','Menyerap COâ‚‚ dari udara'],correctAnswers:[0,1,3],explanation:'Fotosintesis di kloroplas: butuh cahaya, hasilkan Oâ‚‚, serap COâ‚‚.'},
    {text:'Manakah yang termasuk bilangan prima?',options:['2','9','13','15'],correctAnswers:[0,2],explanation:'2 dan 13 prima. 9=3Ã—3, 15=3Ã—5.'},
    {text:'Nilai yang mencerminkan sila ke-3 Pancasila adalah...',options:['Persatuan bangsa','Keadilan sosial','Gotong royong','Cinta tanah air'],correctAnswers:[0,2,3],explanation:'Sila ke-3 "Persatuan Indonesia" â†’ persatuan, gotong royong, cinta tanah air.'},
    {text:'Fungsi tulang bagi tubuh manusia adalah...',options:['Melindungi organ dalam','Tempat melekatnya otot','Menghasilkan sel darah merah','Menyimpan vitamin C'],correctAnswers:[0,1,2],explanation:'Tulang: pelindung organ, tempat otot melekat, sumsum tulang = sel darah merah.'}
  ];
  renderQed(); updateCounts(); saveQLS();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CSV IMPORT/EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('csvFileIn').addEventListener('change',function(e){
  var f=e.target.files[0];
  if(f) Papa.parse(f,{delimiter:';',header:true,skipEmptyLines:true,complete:r=>processCsvRows(r.data)});
});
function doImport(){
  var txt=document.getElementById('csvTextIn').value.trim();
  if(!txt){ showSt('importStatus','warning','âš ï¸','Paste CSV terlebih dahulu!'); return; }
  Papa.parse(txt,{delimiter:';',header:true,skipEmptyLines:true,complete:r=>processCsvRows(r.data),error:e=>showSt('importStatus','danger','âŒ','Error: '+e.message)});
}
function processCsvRows(rows){
  var n=0;
  rows.forEach(r=>{
    if(!r.soal) return;
    var ca=(r.jawaban_benar||'').toString().split('|').map(x=>parseInt(x.trim())).filter(x=>!isNaN(x));
    questions.push({text:r.soal,options:[r.opsi_a||'',r.opsi_b||'',r.opsi_c||'',r.opsi_d||''],correctAnswers:ca,explanation:r.penjelasan||''});
    n++;
  });
  if(n){ saveQLS(); renderQed(); showSt('importStatus','success','âœ…','<strong>'+n+' soal</strong> berhasil diimport!'); }
  else  showSt('importStatus','danger','âŒ','Tidak ada soal valid!');
}
function exportQCSV(){
  var rows=[['soal','opsi_a','opsi_b','opsi_c','opsi_d','jawaban_benar','penjelasan']];
  questions.forEach(q=>rows.push([q.text,...q.options,q.correctAnswers.join('|'),q.explanation||'']));
  dlFile(rows.map(r=>r.map(c=>'"'+(c||'').toString().replace(/"/g,'""')+'"').join(';')).join('\n'),'soal_pgk.csv','text/csv');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOCAL DATABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLocal(){
  var sort=document.getElementById('lsSort').value;
  var data=[...localDB];
  if(sort==='newest')     data.sort((a,b)=>b.ts-a.ts);
  if(sort==='score_desc') data.sort((a,b)=>b.score-a.score);
  if(sort==='score_asc')  data.sort((a,b)=>a.score-b.score);
  if(sort==='name')       data.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  renderLocalRows(data);
  renderLocalStats();
  updateCounts();
}
function renderLocalRows(data){
  var body=document.getElementById('localBody');
  if(!data.length){ body.innerHTML='<tr><td colspan="9"><div class="sheet-empty"><div class="sheet-empty-icon">ğŸ“­</div><div>Belum ada data</div></div></td></tr>'; document.getElementById('localCount').textContent='0 baris'; return; }
  body.innerHTML=data.map((r,i)=>{
    var pass=r.score>=cfg.kkm;
    var sc=r.score>=80?'var(--teal)':pass?'var(--gold-dk)':'var(--red)';
    var dt=new Date(r.ts);
    var dtStr=dt.toLocaleDateString('id-ID',{day:'2-digit',month:'short',year:'numeric'})+' '+dt.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
    var dur=r.timeTaken>=60?Math.floor(r.timeTaken/60)+'m'+(r.timeTaken%60)+'d':r.timeTaken+'d';
    var syncBadge=r.synced?'<span class="badge badge-teal">â˜ Synced</span>':'<span class="badge badge-navy">â³ Lokal</span>';
    return `<tr data-name="${(r.name||'').toLowerCase()}" data-nis="${(r.nis||'').toLowerCase()}" data-status="${pass?'LULUS':'TIDAK LULUS'}">
      <td class="cell-id">${i+1}</td>
      <td class="cell-time">${dtStr}</td>
      <td><span class="cell-nim">${esc(r.nis||'')}</span></td>
      <td class="cell-name">${esc(r.name||'')}</td>
      <td><span class="cell-score" style="color:${sc}">${r.score}</span></td>
      <td style="font-size:12px;color:var(--sub)">${r.correct}/${r.total}</td>
      <td class="cell-time">${dur}</td>
      <td><span class="badge ${pass?'badge-teal':'badge-red'}">${pass?'âœ… Lulus':'âŒ Tidak'}</span></td>
      <td>${syncBadge}</td>
    </tr>`;
  }).join('');
  document.getElementById('localCount').textContent=data.length+' baris';
}
function filterLocal(){
  var q=(document.getElementById('lsSearch')||{value:''}).value.toLowerCase();
  var fs=document.getElementById('lsFilterSt').value;
  document.querySelectorAll('#localBody tr').forEach(r=>{ if(!r.dataset.name) return; r.style.display=(r.dataset.name.includes(q)||r.dataset.nis.includes(q))&&(!fs||r.dataset.status===fs)?'':'none'; });
}
function renderLocalStats(){
  var el=document.getElementById('localDbStats');
  if(!localDB.length){ el.innerHTML=''; return; }
  var scores=localDB.map(r=>r.score);
  var avg=Math.round(scores.reduce((a,b)=>a+b,0)/scores.length);
  var lulus=localDB.filter(r=>r.score>=cfg.kkm).length;
  var synced=localDB.filter(r=>r.synced).length;
  el.innerHTML=`<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
    ${sc('ğŸ‘¥',localDB.length,'Peserta','var(--navy)')}${sc('âœ…',lulus,'Lulus','var(--teal)')}${sc('ğŸ“ˆ',avg,'Rata-rata','var(--gold-dk)')}${sc('â˜',synced+'/'+localDB.length,'Synced','#059669')}
  </div>`;
}
function sc(icon,val,lbl,color){ return `<div class="scard"><div class="scard-stripe" style="background:${color}"></div><div class="sicon">${icon}</div><div class="sval" style="color:${color}">${val}</div><div class="slbl">${lbl}</div></div>`; }
function clearLocal(){ if(!localDB.length||confirm('Hapus semua data lokal?')){ localDB=[]; localStorage.setItem('pgk_res',JSON.stringify(localDB)); renderLocal(); } }
function exportLocalCSV(){
  if(!localDB.length){ toast('Belum ada data!','warning'); return; }
  var rows=[['No','Waktu','NIS','Nama','Nilai','Benar','Total','Durasi_detik','Status','Synced']];
  localDB.forEach((r,i)=>rows.push([i+1,new Date(r.ts).toLocaleString('id-ID'),r.nis,r.name,r.score,r.correct,r.total,r.timeTaken,r.score>=cfg.kkm?'LULUS':'TIDAK LULUS',r.synced?'Ya':'Tidak']));
  dlFile(rows.map(r=>r.map(c=>'"'+(c||'').toString().replace(/"/g,'""')+'"').join(';')).join('\n'),'hasil_pgk_'+Date.now()+'.csv','text/csv');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STUDENT EXAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetExamUI(){
  answers={}; curQ=0; examResult=null;
  if(timerH){ clearInterval(timerH); timerH=null; }
  ['loginPage','examPage','resultPage'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById('loginPage').classList.remove('hidden');
  document.getElementById('loginName').textContent=cfg.examName;
  document.getElementById('loginSchool').textContent=cfg.examSchool;
  document.getElementById('loginTotalQ').textContent=questions.length;
  document.getElementById('loginDur').textContent=cfg.duration;
  document.getElementById('loginKKM').textContent=cfg.kkm;
}

function startExam(){
  var name=document.getElementById('sName').value.trim();
  var nis=document.getElementById('sId').value.trim();
  if(!name||!nis){ toast('Lengkapi nama dan NIS!','warning'); return; }
  if(!questions.length){ toast('Soal belum tersedia! Admin belum mengupload soal.','warning'); return; }
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('examPage').classList.remove('hidden');
  timeLeft=cfg.duration*60; answers={}; curQ=0;
  startTimer(); renderQ();
}

function startTimer(){
  timerH=setInterval(()=>{
    timeLeft--;
    var m=Math.floor(timeLeft/60),s=timeLeft%60;
    document.getElementById('timerDisp').textContent=(m<10?'0':'')+m+':'+(s<10?'0':'')+s;
    document.getElementById('timerBar').classList.toggle('warn',timeLeft<=300);
    if(timeLeft<=0){ clearInterval(timerH); finishExam(); }
  },1000);
}

function renderQ(){
  var q=questions[curQ], total=questions.length;
  var pct=Math.round((curQ+1)/total*100);
  document.getElementById('progLbl').textContent='Soal '+(curQ+1)+' dari '+total;
  document.getElementById('progPct').textContent=pct+'%';
  document.getElementById('progFill').style.width=pct+'%';
  document.getElementById('prevBtn').disabled=curQ===0;
  var isLast=curQ===total-1;
  document.getElementById('nextBtn').classList.toggle('hidden',isLast);
  document.getElementById('finishBtn').classList.toggle('hidden',!isLast);
  var chosen=answers[curQ]||new Set();
  document.getElementById('qwrap').innerHTML=`
    <div class="qhead">
      <span class="qnum">ğŸ“Œ Soal ${curQ+1} / ${total}</span>
      <span class="badge badge-purple">PGK</span>
      ${chosen.size?`<span class="badge badge-teal">${chosen.size} dipilih</span>`:''}
    </div>
    <div class="qbody">
      <div class="q-instr">â˜‘ï¸ Pilih <strong>semua jawaban yang benar</strong> â€” bisa lebih dari satu!</div>
      <div class="qtext">${esc(q.text)}</div>
      <div class="pgk-opts">
        ${q.options.map((opt,i)=>`
          <button class="pgk-opt ${chosen.has(i)?'checked':''}" onclick="toggleAns(${i})">
            <span class="opt-chkbox">${chosen.has(i)?'âœ“':''}</span>
            <span class="opt-ltr">${LETTERS[i]}</span>
            <span class="opt-txt">${esc(opt)}</span>
          </button>`).join('')}
      </div>
    </div>`;
}

function toggleAns(oi){
  if(!answers[curQ]) answers[curQ]=new Set();
  var s=answers[curQ];
  if(s.has(oi)) s.delete(oi); else s.add(oi);
  renderQ();
}
function navQ(dir){ curQ+=dir; curQ=Math.max(0,Math.min(curQ,questions.length-1)); renderQ(); }
function confirmFinish(){
  var un=questions.filter((_,i)=>!answers[i]||answers[i].size===0).length;
  if(confirm(un>0?`Ada ${un} soal belum dijawab. Yakin selesai?`:'Yakin ingin menyelesaikan ujian?')) finishExam();
}

function finishExam(){
  if(timerH){ clearInterval(timerH); timerH=null; }
  var timeTaken=cfg.duration*60-timeLeft, correct=0, details=[];
  questions.forEach((q,i)=>{
    var chosen=answers[i]?[...answers[i]]:[];
    var ps=calcScore(chosen,q.correctAnswers,q.options.length);
    correct+=setEq(new Set(chosen),new Set(q.correctAnswers))?1:0;
    details.push({q,chosen,correct:q.correctAnswers,partScore:ps,full:setEq(new Set(chosen),new Set(q.correctAnswers))});
  });
  var finalScore=Math.round(details.reduce((a,d)=>a+d.partScore,0)/questions.length);
  var name=document.getElementById('sName').value.trim();
  var nis=document.getElementById('sId').value.trim();
  examResult={ts:Date.now(),name,nis,score:finalScore,correct,total:questions.length,timeTaken,details,synced:false};
  localDB.push(examResult);
  localStorage.setItem('pgk_res',JSON.stringify(localDB));
  showResultPage(examResult);
  // Auto-sync jika mode auto
  if(SYNC_MODE==='auto'&&GAS_URL){ autoSync(); }
}

function autoSync(){
  var bar=document.getElementById('syncStudentBar');
  bar.innerHTML=mkA('info','','<span class="spinner"></span> Menyimpan ke Google Sheets...');
  sendToSheets(examResult,(ok,msg)=>{
    if(ok){
      examResult.synced=true;
      localStorage.setItem('pgk_res',JSON.stringify(localDB));
      bar.innerHTML='<div class="sync-bar synced">â˜ âœ… Hasil berhasil disimpan ke Google Sheets secara otomatis!</div>';
      document.getElementById('saveSheetBtn').textContent='âœ“ Sudah Tersimpan';
      document.getElementById('saveSheetBtn').disabled=true;
    } else {
      bar.innerHTML='<div class="sync-bar error">âš ï¸ Auto-sync gagal. Klik "Simpan ke Google Sheets" manual.</div>';
    }
  });
}

function saveToSheets(){
  if(!GAS_URL){ showSt('saveStatus','warning','âš ï¸','URL Google Sheets belum dikonfigurasi di panel Admin!'); return; }
  if(!examResult){ return; }
  document.getElementById('saveStatus').innerHTML=mkA('info','','<span class="spinner"></span> Mengirim ke Google Sheets...');
  document.getElementById('saveSheetBtn').disabled=true;
  sendToSheets(examResult,(ok)=>{
    if(ok){
      examResult.synced=true;
      localStorage.setItem('pgk_res',JSON.stringify(localDB));
      showSt('saveStatus','success','âœ…','Berhasil disimpan ke Google Sheets!');
      document.getElementById('saveSheetBtn').textContent='âœ“ Tersimpan';
    } else {
      document.getElementById('saveSheetBtn').disabled=false;
      showSt('saveStatus','warning','âš ï¸','Terkirim (verifikasi di Sheets).');
    }
  });
}

function calcScore(chosen,correct,total){
  if(cfg.scoringMode==='strict') return setEq(new Set(chosen),new Set(correct))?100:0;
  var tp=chosen.filter(c=>correct.includes(c)).length;
  var fp=chosen.filter(c=>!correct.includes(c)).length;
  return Math.max(0,(correct.length?tp/correct.length:0)-(total>0?fp/total:0))*100;
}
function setEq(a,b){ if(a.size!==b.size) return false; for(var v of a) if(!b.has(v)) return false; return true; }

function showResultPage(res){
  document.getElementById('examPage').classList.add('hidden');
  document.getElementById('resultPage').classList.remove('hidden');
  var pass=res.score>=cfg.kkm;
  var C=2*Math.PI*52;
  var ring=document.getElementById('ringFill');
  ring.style.strokeDasharray=C; ring.style.strokeDashoffset=C;
  ring.className='ring-fill '+(res.score>=80?'c-teal':pass?'c-gold':'c-red');
  setTimeout(()=>{ ring.style.strokeDashoffset=C-(res.score/100)*C; },100);
  document.getElementById('scoreNum').textContent=res.score;
  document.getElementById('resStatus').textContent=res.score>=80?'Luar Biasa! ğŸ‰':pass?'Baik! ğŸ‘':'Perlu Belajar Lagi ğŸ“š';
  document.getElementById('resSub').textContent=pass?'Selamat! Anda dinyatakan LULUS.':'Nilai belum mencapai KKM ('+cfg.kkm+'). Semangat!';
  var m=Math.floor(res.timeTaken/60),s=res.timeTaken%60;
  document.getElementById('resGrid').innerHTML=
    rc('ğŸ‘¤ Nama',res.name)+rc('ğŸ†” NIS/NIM',res.nis)+
    rc('âœ… Benar Penuh',res.correct+' dari '+res.total)+rc('â± Waktu',m+'m '+s+'d')+
    rc('ğŸ† Status',pass?'<span class="badge badge-teal">LULUS</span>':'<span class="badge badge-red">TIDAK LULUS</span>')+rc('ğŸ“Š KKM',cfg.kkm);

  // Review
  var revHtml=`<div style="padding:14px 20px 8px;border-top:1px solid var(--border);font-size:13.5px;font-weight:700">ğŸ“– Pembahasan Per Soal</div>
  <div style="overflow:auto"><table class="dtbl" style="margin:0 0 8px">
    <thead><tr><th>No</th><th>Soal</th><th>Anda</th><th>Benar</th><th>Nilai</th></tr></thead><tbody>
    ${res.details.map((d,i)=>{
      var cl=d.chosen.map(c=>LETTERS[c]).join(', ')||'â€”';
      var co=d.correct.map(c=>LETTERS[c]).join(', ')||'â€”';
      var pct=Math.round(d.partScore);
      var clr=pct===100?'var(--teal)':pct>0?'var(--gold-dk)':'var(--red)';
      return `<tr><td class="cell-id">${i+1}</td>
        <td style="font-size:12px;max-width:180px">${esc(d.q.text)}${d.q.explanation?`<div style="margin-top:5px;font-size:10.5px;color:var(--sub);background:var(--surface);padding:5px 8px;border-radius:5px;border-left:3px solid var(--gold)">ğŸ’¡ ${esc(d.q.explanation)}</div>`:''}</td>
        <td style="font-size:11.5px;font-weight:600;color:${d.full?'var(--teal)':'var(--red)'}">${cl}</td>
        <td style="font-size:11.5px;font-weight:700;color:var(--teal)">${co}</td>
        <td style="font-weight:800;color:${clr}">${pct}</td></tr>`;
    }).join('')}
    </tbody></table></div>`;
  document.getElementById('reviewSec').innerHTML=revHtml;

  // Jika mode manual, tampilkan tombol save; jika auto, sembunyikan (auto akan handle)
  if(SYNC_MODE==='manual'){ document.getElementById('syncStudentBar').innerHTML=''; }
}

function rc(lbl,val){ return `<div class="rchip"><div class="rchip-lbl">${lbl}</div><div class="rchip-val">${val}</div></div>`; }

function dlMyCSV(){
  if(!examResult) return;
  var rows=[['Nama','NIS','Nilai','Benar','Total','Durasi','Status'],[examResult.name,examResult.nis,examResult.score,examResult.correct,examResult.total,examResult.timeTaken,examResult.score>=cfg.kkm?'LULUS':'TIDAK LULUS']];
  examResult.details.forEach((d,i)=>rows.push(['Soal '+(i+1),d.q.text.substring(0,60),'Dipilih:'+d.chosen.map(c=>LETTERS[c]).join('|'),'Benar:'+d.correct.map(c=>LETTERS[c]).join('|'),Math.round(d.partScore)]));
  dlFile(rows.map(r=>r.map(c=>'"'+(c||'').toString().replace(/"/g,'""')+'"').join(';')).join('\n'),'hasil_'+examResult.nis+'_'+Date.now()+'.csv','text/csv');
}
function resetExam(){ resetExamUI(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function mkA(t,i,m){ return `<div class="alert alert-${t}"><span class="alert-icon">${i}</span><span>${m}</span></div>`; }
function showSt(el,t,i,m){ document.getElementById(el).innerHTML=mkA(t,i,m); setTimeout(()=>{var e=document.getElementById(el);if(e)e.innerHTML='';},4000); }
function dlFile(c,n,t){ var a=document.createElement('a');a.href=URL.createObjectURL(new Blob([c],{type:t}));a.download=n;a.click(); }
function toast(msg,type='info'){
  var t=document.createElement('div');
  t.style.cssText='position:fixed;bottom:22px;right:22px;z-index:9999;padding:11px 18px;border-radius:9px;font-family:Sora,sans-serif;font-size:12.5px;font-weight:600;box-shadow:0 6px 22px rgba(0,0,0,.16);animation:fadeUp .3s ease;';
  t.style.background=type==='success'?'var(--teal)':type==='warning'?'var(--gold)':'var(--navy)';
  t.style.color=type==='warning'?'var(--navy)':'white';
  t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),2600);
}
</script>
</body>
</html>
